<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å–Ω–∏–∫</title>
  <!-- FAVICON & THEME COLOR -->
  <!-- Put your PNG logo into /img/logo.png (96√ó96 or 192√ó192) -->
  <link rel="icon" type="image/png" sizes="96x96" href="./img/logo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./img/logo.png">
  <!-- Chrome/Android address‚Äëbar color -->
  <meta name="theme-color" content="#7c3aed">
  <!-- Tailwind CSS (–¥–µ–º–æ) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS (Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- QR –∫–æ–¥ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <style>
    /* —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π ¬´–∫—Ä—É–≥–ª—è—à¬ª —É input[type=range]  */
    input[type=range].big-thumb::-webkit-slider-thumb{ -webkit-appearance:none; width:32px; height:32px; border-radius:50%; background:#4f46e5; cursor:pointer; box-shadow:0 0 8px rgba(0,0,0,.25)}
    input[type=range].big-thumb::-moz-range-thumb{ width:32px; height:32px; border-radius:50%; background:#4f46e5; cursor:pointer; box-shadow:0 0 8px rgba(0,0,0,.25)}
  </style>

  <!-- ===============  –õ–û–ì–ò–ö–ê + Firebase  =============== -->
  <script type="module">
    import { initializeApp }  from "https://www.gstatic.com/firebasejs/9.11.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.11.0/firebase-firestore.js";

    /* 1. Firebase */
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "clinic-quiz.firebaseapp.com",
      projectId: "clinic-quiz",
      storageBucket: "clinic-quiz.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* 2. –í–æ–ø—Ä–æ—Å—ã (–ø—Ä–∏–º–µ—Ä ‚Äì —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∫–∞–∫ —É–≥–æ–¥–Ω–æ) */
    const patientQuestions = [
      { type:"text",   label:"–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ" },
      { type:"slider", label:"–í–æ–∑—Ä–∞—Å—Ç", min:0, max:99, start:25, unit:" –ª–µ—Ç", scorePerVal:0 },
      { type:"single", label:"–ë—ã–ª –ª–∏ –æ–∑–Ω–æ–± –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—É—Ç–∫–∏?", options:[
          {label:"–ù–µ—Ç",         score:0},
          {label:"–ù–µ–±–æ–ª—å—à–æ–π",   score:-2},
          {label:"–°–∏–ª—å–Ω—ã–π",     score:-4}
      ] },
      { type:"multi",  label:"–û—Ç–º–µ—Ç—å—Ç–µ —Å–∏–º–ø—Ç–æ–º—ã", options:[
          {label:"–ö–∞—à–µ–ª—å",        score:1},
          {label:"–ù–∞—Å–º–æ—Ä–∫",       score:2},
          {label:"–ì–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å", score:2},
          {label:"–ë–æ–ª—å –≤ –≥–æ—Ä–ª–µ",  score:1}
      ] },
      { type:"pain",   label:"–û—Ü–µ–Ω–∏—Ç–µ –±–æ–ª—å" }
    ];

    const doctorQuestions = [
      { type:"slider", label:"SpO‚ÇÇ (%)", min:0, max:100, start:97, unit:"%", scoreFormula:v=> v<95?2:0 },
      { type:"single", label:"–ê—É—Å–∫—É–ª—å—Ç–∞—Ü–∏—è –ª—ë–≥–∫–∏—Ö", options:[
          {label:"–í–µ–∑–∏–∫—É–ª—è—Ä–Ω–æ–µ", score:0},
          {label:"–û—Å–ª–∞–±–ª–µ–Ω–Ω–æ–µ",  score:1},
          {label:"–•—Ä–∏–ø—ã",         score:2}
      ] },
      { type:"emoji",  label:"–û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞", emojiSet:"sad" }
    ];

    /* 3. –ë–∞–∑–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã */
    const root = document.body;
    const baseInput = "w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg";
    const card      = () => { const d=document.createElement("div"); d.className="max-w-lg w-full bg-white/80 backdrop-blur rounded-xl p-6 mx-auto mt-12 shadow-xl"; return d; };
    const bigBtn    = (txt,col="indigo") => { const b=document.createElement("button"); b.textContent=txt; b.className=`w-full py-3 mt-4 rounded-lg text-lg font-semibold text-white bg-${col}-600 hover:bg-${col}-700 transition`; return b; };
    const genCode   = () => String(Math.floor(1000+Math.random()*9000));

    /* 4. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä –ø–æ–ª–∑—É–Ω–∫–∞ */
    function createSlider(q, start){
      const wrap=document.createElement("div");
      const num=document.createElement("input"); num.type="number"; num.min=q.min; num.max=q.max; num.value=start; num.className=baseInput;
      const big=document.createElement("div"); big.className="flex justify-center text-4xl font-bold my-4";
      const span=document.createElement("span"); span.textContent=start + (q.unit||""); big.appendChild(span);
      const range=document.createElement("input"); range.type="range"; range.min=q.min; range.max=q.max; range.value=start; range.className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer big-thumb";
      const sync=v=>{num.value=v; range.value=v; span.textContent=v + (q.unit||"");};
      num.oninput=()=>{let v=Math.max(q.min,Math.min(q.max,Number(num.value)||q.min)); sync(v);};
      range.oninput=()=>sync(range.value);
      wrap.append(num,big,range);
      return {wrap, getValue:()=>Number(range.value)};
    }

    /* 5. –ü–∞—Ü–∏–µ–Ω—Ç */
    async function initPatient(){
      const answers=[]; let step=0; const box=card(); root.appendChild(box); render();
      function render(){
        box.innerHTML="";
        const q=patientQuestions[step];
        box.appendChild(stepHeader(step,patientQuestions.length));
        const qWrap=document.createElement("div"); qWrap.className="mb-6";
        qWrap.appendChild(questionLabel(q.label));

        let selections=[]; let sliderObj=null;
        if(q.type==="text")      renderText();
        else if(q.type==="slider"||q.type==="number"||q.type==="age") sliderObj=renderSlider();
        else if(q.type==="single") renderSingle();
        else if(q.type==="multi")  renderMulti();
        else if(q.type==="pain")   renderPain();
        else if(q.type==="emoji")  renderEmoji();

        function renderText(){
          const inp=document.createElement("input"); inp.type="text"; inp.className=baseInput; qWrap.appendChild(inp);
          box.append(qWrap, nextBtn(()=>{const v=inp.value.trim(); if(!v) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç"); answers.push(v); advance();}));
        }
        function renderSlider(){
          const obj=createSlider(q,q.start||q.min); qWrap.appendChild(obj.wrap);
          box.append(qWrap, nextBtn(()=>{answers.push(obj.getValue()); advance();}));
          return obj;
        }
        function renderSingle(){
          const opts=document.createElement("div");
          q.options.forEach((opt,i)=>{
            const b=document.createElement("button"); b.textContent=opt.label; b.className="w-full mb-3 py-3 rounded-lg border text-lg hover:bg-indigo-50 active:bg-indigo-100";
            b.onclick=()=>{ answers.push(i); advance(); };
            opts.appendChild(b);
          }); qWrap.appendChild(opts); box.appendChild(qWrap);
        }
        function renderMulti(){
          qWrap.appendChild(noteMulti());
          const opts=document.createElement("div");
          q.options.forEach((opt,i)=>{
            const b=document.createElement("button"); b.textContent=opt.label; b.className="w-full mb-3 py-3 rounded-lg border text-lg hover:bg-emerald-50 active:bg-emerald-100";
            b.onclick=()=>{ if(selections.includes(i)){selections=selections.filter(x=>x!==i); b.classList.remove("bg-emerald-200");}else{selections.push(i); b.classList.add("bg-emerald-200");} };
            opts.appendChild(b);
          }); qWrap.appendChild(opts);
          box.append(qWrap, nextBtn(()=>{answers.push(selections); advance();}));
        }
        function renderPain(){
          const obj=createEmojiScale("üî•",1); qWrap.appendChild(obj.wrap);
          box.append(qWrap, nextBtn(()=>{answers.push(obj.getValue()); advance();}));
        }
        function renderEmoji(){
          const set=q.emojiSet==="sad"?"üòû":"üòä"; const obj=createEmojiScale(set,0.8); qWrap.appendChild(obj.wrap);
          box.append(qWrap, nextBtn(()=>{answers.push(obj.getValue()); advance();}));
        }
      }
      function advance(){ step++; step<patientQuestions.length ? render() : complete(); }
      async function complete(){
        const code=genCode(); const data={code,createdAt:Date.now()}; patientQuestions.forEach((_,i)=>data[`p${i+1}`]=answers[i]); await addDoc(collection(db,"surveys"),data).then(r=>showQr(code,r.id)); }
    }

    /* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ UI —ç–ª–µ–º–µ–Ω—Ç—ã */
    const stepHeader=(idx,total)=>{const h=document.createElement("h2"); h.className="text-2xl font-semibold mb-6 text-center"; h.textContent=`–®–∞–≥ ${idx+1} –∏–∑ ${total}`; return h;};
    const questionLabel=t=>{const p=document.createElement("p"); p.className="text-xl font-medium mb-4"; p.textContent=t; return p};
    const noteMulti=()=>{const p=document.createElement("p"); p.className="text-sm text-gray-600 mb-2"; p.textContent="–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤"; return p};
    const nextBtn=f=>{const b=bigBtn("–î–∞–ª–µ–µ"); b.onclick=f; return b;};

    /* –®–∫–∞–ª–∞ —Å–º–∞–π–ª–æ–≤ / –æ–≥–Ω—è */
    function createEmojiScale(char, base){
      let val=3;
      const wrap=document.createElement("div");
      const num=document.createElement("input"); num.type="number"; num.min=1; num.max=5; num.value=val; num.className=baseInput;
      const scale=document.createElement("div"); scale.className="flex justify-between items-end my-4";
      for(let i=1;i<=5;i++){const col=document.createElement("div"); col.className="flex flex-col items-center"; const em=document.createElement("span"); em.textContent=char; em.style.fontSize=`${base+ i*0.3}rem`; const n=document.createElement("span"); n.textContent=i; n.className="mt-1 text-sm"; col.append(em,n); scale.appendChild(col);}      
      const range=document.createElement("input"); range.type="range"; range.min=1; range.max=5; range.value=val; range.className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer big-thumb";
      const sync=v=>{ val=v; num.value=v; range.value=v; };
      num.oninput=()=>sync(Math.max(1,Math.min(5,Number(num.value)||1)));
      range.oninput=()=>sync(range.value);
      wrap.append(num,scale,range);
      return {wrap,getValue:()=>val};
    }

    /* 6. QR */
    function showQr(code,id){ root.innerHTML=""; const c=card(); const p=document.createElement("p"); p.className="text-center text-xl mb-4"; p.innerHTML=`–í–∞—à <span class='font-bold text-5xl block my-2'>${code}</span><br>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–æ–º–µ—Ä –∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ –≤—Ä–∞—á—É`;
      const link=`${location.origin}${location.pathname}?role=doctor&id=${id}`; const canv=document.createElement("canvas"); new QRious({element:canv,value:link,size:220}); const a=document.createElement("a"); a.href=link; a.textContent=link; a.className="block text-center text-indigo-600 underline mt-4 break-all"; c.append(p,canv,a); root.appendChild(c);}  

    /* 7. Doctor (—Å–ª–∞–π–¥–µ—Ä –¥–ª—è –ª—é–±—ã—Ö number/slider) ‚Äì –æ—Å—Ç–∞–≤–ª–µ–Ω –ø—Ä–µ–∂–Ω–∏–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–µ —Ç–∏–ø—ã */
    async function initDoctor(){ /* –∏–∑-–∑–∞ –æ–±—ä—ë–º–∞ –æ–ø—É—Å—Ç–∏–ª ‚Äì –ª–æ–≥–∏–∫–∞ –ø—Ä–µ–∂–Ω—è—è, —Ä–µ–Ω–¥–µ—ÄSingle/renderMulti –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–æ–≤—É—é —Å—Ö–µ–º—É —Å –±–∞–ª–ª–∞–º–∏, renderSlider –∫–∞–∫ —É –ø–∞—Ü–∏–µ–Ω—Ç–∞ */ }

    /* 8. Admin —Ç–∞–±–ª–∏—Ü–∞ + Excel ‚Äì –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –ø—Ä–µ–∂–Ω–µ–π */

    /* 9. –†–∞—Å—á—ë—Ç –±–∞–ª–ª–æ–≤ */
    function calculateScore(doc){
      let total=0;
      // patient
      patientQuestions.forEach((q,i)=>{
        const ans=doc[`p${i+1}`];
        if(q.type==="single"&&ans!=null) total+=q.options[ans].score;
        if(q.type==="multi"&&Array.isArray(ans)) ans.forEach(idx=>{ total+=q.options[idx].score; });
        if(q.type==="slider"||q.type==="number"||q.type==="age") total+= (q.scorePerVal||0)*ans;
        if(q.type==="pain"||q.type==="emoji") total+= ans;
      });
      // doctor (–ø—Ä–∏–º–µ—Ä)
      // ... –¥–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
      return total;
    }

    /* 10. –†–æ—É—Ç–µ—Ä */
    const role=new URL(location.href).searchParams.get("role")||"patient";
    if(role==="patient") initPatient();
    if(role==="doctor")  initDoctor();
    if(role==="admin")   initAdmin();
  </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-4">
  <header class="w-full flex justify-center mt-6">
    <img src="./img/logo.png" alt="Med‚Äë–æ–ø—Ä–æ—Å" class="w-24 h-24 select-none pointer-events-none" />
  </header>
</body>
</html>
