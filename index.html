<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å–Ω–∏–∫</title>
  <!-- Tailwind CSS CDN (–¥–µ–º–æ) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS (Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
  <!-- QRious -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <!-- Firebase v9 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.11.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      doc,
      getDoc,
      updateDoc,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/9.11.0/firebase-firestore.js";

    /* ========= 1. –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase ========= */
    // üëâ –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –∫–æ–Ω—Ñ–∏–≥
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "clinic-quiz.firebaseapp.com",
      projectId: "clinic-quiz",
      storageBucket: "clinic-quiz.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ========= 2. –û–ø–∏—Å–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤ ========= */
    const patientQuestions = [
      { type: "text",   label: "–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ" },
      { type: "slider", label: "–í–æ–∑—Ä–∞—Å—Ç (0‚Äë99 –ª–µ—Ç)", min: 0, max: 99 },
      { type: "single", label: "–ë—ã–ª –ª–∏ –æ–∑–Ω–æ–± –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—É—Ç–∫–∏?", options: ["–ù–µ—Ç", "–ù–µ–±–æ–ª—å—à–æ–π", "–°–∏–ª—å–Ω—ã–π"] },
      { type: "multi",  label: "–û—Ç–º–µ—Ç—å—Ç–µ —Å–∏–º–ø—Ç–æ–º—ã", options: ["–ö–∞—à–µ–ª—å", "–ù–∞—Å–º–æ—Ä–∫", "–ì–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å", "–ë–æ–ª—å –≤ –≥–æ—Ä–ª–µ"] },
      { type: "single", label: "–û—Ü–µ–Ω–∏—Ç–µ –±–æ–ª—å (0 ‚Äì 5)", options: ["0", "1", "2", "3", "4", "5"] }
    ];

    const doctorQuestions = [
      { type: "single", label: "–ê—É—Å–∫—É–ª—å—Ç–∞—Ü–∏—è –ª—ë–≥–∫–∏—Ö", options: ["–í–µ–∑–∏–∫—É–ª—è—Ä–Ω–æ–µ", "–û—Å–ª–∞–±–ª–µ–Ω–Ω–æ–µ", "–•—Ä–∏–ø—ã"] },
      { type: "number", label: "SpO‚ÇÇ (%)" },
      { type: "multi",  label: "–ù–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–µ –ª–µ—á–µ–Ω–∏–µ", options: ["–ê–Ω—Ç–∏–±–∏–æ—Ç–∏–∫", "–ñ–∞—Ä–æ–ø–æ–Ω–∏–∂–∞—é—â–µ–µ", "–ò–Ω–≥–∞–ª—è—Ü–∏–∏", "–ì–æ—Å–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è"] }
    ];

    /* ========= 3. –£—Ç–∏–ª–∏—Ç—ã ========= */
    const root = document.body;
    function card() {
      const d = document.createElement("div");
      d.className = "max-w-lg w-full bg-white/80 backdrop-blur rounded-xl p-6 mx-auto mt-12 shadow-xl";
      return d;
    }
    function bigBtn(text, color = "indigo") {
      const b = document.createElement("button");
      b.textContent = text;
      b.className = `w-full py-3 mt-4 rounded-lg text-lg font-semibold text-white bg-${color}-600 hover:bg-${color}-700 transition`;
      return b;
    }
    const baseInput = "w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg";

    function genCode() { return String(Math.floor(1000 + Math.random() * 9000)); }

    /* ========= 4. Patient Wizard ========= */
    async function initPatient() {
      const answers = [];
      let step = 0;
      const patCard = card();
      root.appendChild(patCard);
      showStep();

      function showStep() {
        patCard.innerHTML = "";
        const q = patientQuestions[step];
        const title = document.createElement("h2");
        title.className = "text-2xl font-semibold mb-6 text-center";
        title.textContent = `–®–∞–≥ ${step + 1} –∏–∑ ${patientQuestions.length}`;
        patCard.appendChild(title);

        const qWrap = document.createElement("div");
        qWrap.className = "mb-6";
        const qLabel = document.createElement("p");
        qLabel.className = "text-xl font-medium mb-4";
        qLabel.textContent = q.label;
        qWrap.appendChild(qLabel);

        let multiSelections = [];
        if (q.type === "text") {
          const inp = document.createElement("input");
          inp.type = "text";
          inp.placeholder = "–í–≤–µ–¥–∏—Ç–µ";
          inp.className = baseInput;
          qWrap.appendChild(inp);
          const next = bigBtn("–î–∞–ª–µ–µ");
          next.onclick = () => {
            const val = inp.value.trim();
            if (!val) return alert("–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ");
            answers.push(val);
            advance();
          };
          patCard.append(qWrap, next);
        }
        else if (q.type === "slider") {
          // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ
          const valueSpan = document.createElement("span");
          valueSpan.className = "block text-4xl font-bold text-center mb-4";
          valueSpan.textContent = "25";

          const range = document.createElement("input");
          range.type = "range";
          range.min = q.min;
          range.max = q.max;
          range.value = 25;
          range.className = "w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer";
          range.oninput = () => {
            valueSpan.textContent = range.value;
            numInput.value = range.value;
          };

          const numInput = document.createElement("input");
          numInput.type = "number";
          numInput.min = q.min;
          numInput.max = q.max;
          numInput.value = 25;
          numInput.className = baseInput + " mt-4";
          numInput.oninput = () => {
            let v = Number(numInput.value);
            if (isNaN(v)) v = 0;
            if (v < q.min) v = q.min;
            if (v > q.max) v = q.max;
            numInput.value = v;
            range.value = v;
            valueSpan.textContent = v;
          };

          qWrap.append(valueSpan, range, numInput);
          const next = bigBtn("–î–∞–ª–µ–µ");
          next.onclick = () => {
            answers.push(Number(range.value));
            advance();
          };
          patCard.append(qWrap, next);
        }
        else if (q.type === "single") {
          const optsWrap = document.createElement("div");
          q.options.forEach((opt, idx) => {
            const oBtn = document.createElement("button");
            oBtn.textContent = opt;
            oBtn.className = "w-full mb-3 py-3 rounded-lg border text-lg hover:bg-indigo-50 active:bg-indigo-100";
            oBtn.onclick = () => {
              answers.push(idx);
              advance();
            };
            optsWrap.appendChild(oBtn);
          });
          qWrap.appendChild(optsWrap);
          patCard.appendChild(qWrap);
        }
        else if (q.type === "multi") {
          const note = document.createElement("p");
          note.className = "text-sm text-gray-600 mb-2";
          note.textContent = "–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤";
          qWrap.appendChild(note);

          const optsWrap = document.createElement("div");
          q.options.forEach((opt, idx) => {
            const oBtn = document.createElement("button");
            oBtn.textContent = opt;
            oBtn.className = "w-full mb-3 py-3 rounded-lg border text-lg hover:bg-emerald-50 active:bg-emerald-100";
            oBtn.onclick = () => {
              if (multiSelections.includes(idx)) {
                multiSelections = multiSelections.filter(i => i !== idx);
                oBtn.classList.remove("bg-emerald-200");
              } else {
                multiSelections.push(idx);
                oBtn.classList.add("bg-emerald-200");
              }
            };
            optsWrap.appendChild(oBtn);
          });
          qWrap.appendChild(optsWrap);
          const next = bigBtn("–î–∞–ª–µ–µ (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ)");
          next.onclick = () => {
            answers.push(multiSelections);
            advance();
          };
          patCard.append(qWrap, next);
        }
      }

      async function advance() {
        step++;
        if (step < patientQuestions.length) {
          showStep();
        } else {
          await finish();
        }
      }

      async function finish() {
        const code = genCode();
        try {
          const docData = { code, createdAt: Date.now() };
          patientQuestions.forEach((q, i) => docData[`p${i+1}`] = answers[i]);
          const ref = await addDoc(collection(db, "surveys"), docData);
          showQrAndCode(ref.id, code);
        } catch (e) {
          console.error(e);
          alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: " + e.message);
        }
      }
    }

    /* ========= 5. –ü–æ–∫–∞–∑ QR –∏ –∫–æ–¥–∞ ========= */
    function showQrAndCode(id, code) {
      root.innerHTML = "";
      const c = card();
      const p = document.createElement("p");
      p.className = "text-center text-xl mb-4";
      p.innerHTML = `–í–∞—à <span class='font-bold text-5xl block my-2'>${code}</span> <br>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–ª–∏ –∑–∞–ø–æ–º–Ω–∏—Ç–µ –Ω–æ–º–µ—Ä –∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ –≤—Ä–∞—á—É!`;
      const link = `${location.origin}${location.pathname}?role=doctor&id=${id}`;
      const canvas = document.createElement("canvas");
      new QRious({ element: canvas, value: link, size: 220 });
      const a = document.createElement("a");
      a.href = link;
      a.textContent = link;
      a.className = "block text-center text-indigo-600 underline mt-4 break-all";
      c.append(p, canvas, a);
      root.appendChild(c);
    }

    /* ========= 6. Doctor ========= */
    async function initDoctor(){
      const url=new URL(location.href);
      const docId=url.searchParams.get("id");
      if(docId) loadForm(docId); else renderCodeSearch();
    }
    function renderCodeSearch(){
      const c=card();
      const lbl=document.createElement("label"); lbl.textContent="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–∞—Ü–∏–µ–Ω—Ç–∞:"; lbl.className="block mb-2 text-lg font-medium";
      const inp=document.createElement("input"); inp.maxLength=4; inp.className=baseInput;
      const btn=bigBtn("–ù–∞–π—Ç–∏","emerald");
      btn.onclick=async()=>{
        if(inp.value.length!==4) return alert("–í–≤–µ–¥–∏—Ç–µ 4 —Ü–∏—Ñ—Ä—ã");
        const q=query(collection(db,"surveys"),where("code","==",inp.value));
        const snap=await getDocs(q);
        if(snap.empty) return alert("–ê–Ω–∫–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
        location.href=`${location.pathname}?role=doctor&id=${snap.docs[0].id}`;
      };
      c.append(lbl,inp,btn); root.appendChild(c);
    }
    async function loadForm(id){
      const dSnap=await getDoc(doc(db,"surveys",id));
      if(!dSnap.exists()) return alert("–ê–Ω–∫–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
      const data=dSnap.data();
      const answersB=[]; let step=0; const dCard=card(); root.appendChild(dCard);
      showStep();
      function showStep(){
        dCard.innerHTML="";
        if(step===0){
          const h=document.createElement("h2"); h.className="text-xl font-semibold mb-4 text-center"; h.textContent=`–ö–æ–¥ –ø–∞—Ü–∏–µ–Ω—Ç–∞: ${data.code}`; dCard.appendChild(h);
        }
        if(step>=doctorQuestions.length){ finish(); return; }
        const q=doctorQuestions[step];
        const qWrap=document.createElement("div"); qWrap.className="mb-6";
        const qLabel=document.createElement("p"); qLabel.className="text-xl font-medium mb-4"; qLabel.textContent=q.label; qWrap.appendChild(qLabel);
        let selections=[];
        if(q.type==="single"){
          q.options.forEach((opt,idx)=>{
            const oBtn=document.createElement("button"); oBtn.textContent=opt; oBtn.className="w-full mb-3 py-3 rounded-lg border text-lg hover:bg-indigo-50 active:bg-indigo-100";
            oBtn.onclick=()=>{ answersB.push(idx); step++; showStep(); };
            qWrap.appendChild(oBtn);
          });
          dCard.appendChild(qWrap);
        } else if(q.type==="number"){
          const inp=document.createElement("input"); inp.type="number"; inp.className=baseInput; qWrap.appendChild(inp);
          const next=bigBtn("–î–∞–ª–µ–µ"); next.onclick=()=>{ if(!inp.value||isNaN(inp.value)) return alert("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ"); answersB.push(Number(inp.value)); step++; showStep(); };
          dCard.append(qWrap,next);
        } else if(q.type==="multi"){
          q.options.forEach((opt,idx)=>{
            const mBtn=document.createElement("button"); mBtn.textContent=opt; mBtn.className="w-full mb-3 py-3 rounded-lg border text-lg hover:bg-emerald-50 active:bg-emerald-100";
            mBtn.onclick=()=>{ if(selections.includes(idx)){ selections=selections.filter(i=>i!==idx); mBtn.classList.remove("bg-emerald-200"); } else { selections.push(idx); mBtn.classList.add("bg-emerald-200"); } };
            qWrap.appendChild(mBtn);
          });
          const next=bigBtn("–î–∞–ª–µ–µ (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ)"); next.onclick=()=>{ answersB.push(selections); step++; showStep(); };
          dCard.append(qWrap,next);
        }
      }
      async function finish(){
        const upd={}; doctorQuestions.forEach((_,i)=>upd[`d${i+1}`]=answersB[i]);
        upd.score=calculateScore(data, upd); upd.finishedAt=Date.now();
        await updateDoc(doc(db,"surveys",id),upd);
        dCard.innerHTML=""; const done=document.createElement("p"); done.className="text-2xl font-semibold text-center"; done.textContent=`–ê–Ω–∫–µ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞. –ë–∞–ª–ª: ${upd.score}`; dCard.appendChild(done);
      }
    }

    /* ========= 7. Admin ========= */
    async function initAdmin(){
      try{
        const snap=await getDocs(collection(db,"surveys")); if(snap.empty) return showMsg("–ù–µ—Ç –∞–Ω–∫–µ—Ç");
        const rows=[]; snap.forEach(d=>{ const v=d.data(); rows.push(flat(v)); });
        renderTable(rows);
      }catch(e){ console.error(e); showMsg("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –ë–î"); }
    }
    function flat(v){
      return {
        code:v.code||"",
        fio:v.p1||"",
        age:v.p2||"",
        chills:v.p3!=null?patientQuestions[2].options[v.p3]:"",
        symptoms:Array.isArray(v.p4)? v.p4.map(i=>patientQuestions[3].options[i]).join(", ") : "",
        pain:v.p5||"",
        ausc:v.d1!=null?doctorQuestions[0].options[v.d1]:"",
        spo2:v.d2||"",
        therapy:Array.isArray(v.d3)? v.d3.map(i=>doctorQuestions[2].options[i]).join(", ") : "",
        score:v.score||""
      };
    }
    function showMsg(t){ const c=card(); c.textContent=t; c.classList.add("text-center","text-red-600"); root.appendChild(c);}    
    function renderTable(arr){
      const c=card(); const tbl=document.createElement("table"); tbl.className="min-w-full text-sm border";
      const head=document.createElement("thead"); const hr=document.createElement("tr"); Object.keys(arr[0]).forEach(k=>{ const th=document.createElement("th"); th.className="border px-2 py-1 bg-gray-100"; th.textContent=k; hr.appendChild(th); }); head.appendChild(hr); tbl.appendChild(head);
      const tb=document.createElement("tbody"); arr.forEach(r=>{ const tr=document.createElement("tr"); Object.values(r).forEach(v=>{ const td=document.createElement("td"); td.className="border px-2 py-1"; td.textContent=v; tr.appendChild(td); }); tb.appendChild(tr); }); tbl.appendChild(tb);
      const btn=bigBtn("–°–∫–∞—á–∞—Ç—å Excel","emerald"); btn.onclick=()=>{ const ws=XLSX.utils.json_to_sheet(arr,{header:Object.keys(arr[0])}); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Surveys"); XLSX.writeFile(wb,"surveys.xlsx"); };
      c.append(tbl,btn); root.appendChild(c);
    }

    /* ========= 8. –ë–∞–ª–ª—ã ========= */
    function calculateScore(p, d){
      let s=0;
      if(p.p3!=null) s+= (p.p3+1);
      s+= Number(p.p5||0);
      if(d.d1!=null) s+= d.d1;
      if(d.d2!=null && d.d2<95) s+=2;
      if(Array.isArray(d.d3)) s+= d.d3.length;
      return s;
    }

    /* ========= 9. –†–æ—É—Ç–µ—Ä ========= */
    const role=new URL(location.href).searchParams.get("role")||"patient";
    if(role==="patient") initPatient();
    if(role==="doctor") initDoctor();
    if(role==="admin") initAdmin();

  </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-4"></body>
</html>
