<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Мед-опрос</title>

  <!-- Tailwind CSS через CDN — быстро и красиво -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- QR-код -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <!-- SheetJS для Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* небольшие доработки кнопок-вариантов */
    .btn-option   { @apply w-full py-3 px-4 mb-3 rounded-lg text-lg font-medium bg-slate-200 hover:bg-indigo-100 transition; }
    .btn-option.active { @apply bg-indigo-600 text-white hover:bg-indigo-700; }
    .card         { @apply bg-white/90 backdrop-blur p-6 rounded-2xl shadow-lg mx-auto; max-width: 28rem; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center bg-gradient-to-br from-violet-700 to-pink-600">

  <div id="app" class="w-full px-4"></div>

  <script type="module">
    /* ---------- Firebase ---------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.11.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, getDoc,
      updateDoc, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/9.11.0/firebase-firestore.js";

    /* TODO: вставьте свой firebaseConfig */
    const firebaseConfig = {
      apiKey:   "API_KEY",
      authDomain: "PROJECT.firebaseapp.com",
      projectId:  "PROJECT",
      storageBucket: "PROJECT.appspot.com",
      messagingSenderId: "XXXX",
      appId: "XXX"
    };

    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);

    /* ---------- Определяем режим ---------- */
    const url   = new URL(location.href);
    const role  = url.searchParams.get("role") || "patient";
    let   docId = url.searchParams.get("id")   || null;

    const $app  = document.getElementById('app');

    /* ---------- Вопросы ---------- */
    const patientQ = [
      {type:'text',   label:'Введите фамилию, имя и отчество'},
      {type:'number', label:'Ваш возраст (полных лет)'},
      {type:'single', label:'Была ли температура выше 38 °C за последние сутки?',
                      options:['Нет','Да, кратковременно','Да, держится']},
      {type:'multi',  label:'Отметьте сопутствующие факторы (можно несколько)',
                      options:['Аллергия','Курение','Диабет','Беременность']},
      {type:'single', label:'Шкала боли (0 — нет боли, 3 — сильная)', 
                      options:['0','1','2','3']}
    ];

    const doctorQ = [
      {type:'single', label:'Тип кашля', options:['Нет','Сухой','Влажный']},
      {type:'number', label:'SpO₂ по пульсоксиметру'},
      {type:'multi',  label:'Назначенное лечение (можно несколько)',
                      options:['Жаропонижающее','Антибиотик','Ингаляции','Госпитализация']}
    ];

    /* ---------- Служебные переменные ---------- */
    let pStep = 0, dStep = 0;
    const pAns = [], dAns = [];
    let code   = null;   // 4-значный код пациента

    /* ---------- Рендеры общего назначения ---------- */
    const html = (h) => { $app.innerHTML = h; };       // заменяем содержимое
    const btn  = (text, extra='') => `<button class="w-full py-3 mt-4 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-lg font-semibold ${extra}">${text}</button>`;

    /* ---------- Рендер пациента ---------- */
    function renderPatientStep() {
      const q = patientQ[pStep];
      let inner = `<div class="card">
        <h2 class="text-xl font-semibold mb-6">${q.label}</h2>`;

      if (q.type === 'text' || q.type === 'number') {
        const type = q.type === 'number' ? 'number' : 'text';
        inner += `<input id="inp" type="${type}" class="w-full rounded-lg border px-4 py-3 mb-4" ${type==='number'?'inputmode="numeric"':''} />`;
        inner += btn('Далее');
      } 
      else if (q.type === 'single') {
        q.options.forEach((o,i)=> {
          inner += `<button class="btn-option" onclick="nextPatientStep(${JSON.stringify(o)})">${o}</button>`;
        });
      }
      else if (q.type === 'multi') {
        q.options.forEach((o,i)=> {
          inner += `<button class="btn-option" data-i="${i}" onclick="toggleMulti(this)">${o}</button>`;
        });
        inner += btn('Далее (можно выбрать несколько)');
      }

      inner += `</div>`;
      html(inner);

      if (q.type === 'text' || q.type === 'number' || q.type === 'multi') {
        document.querySelector('button:last-of-type').onclick = ()=> {
          if (q.type === 'multi') {
            const sel = [...document.querySelectorAll('.btn-option.active')].map(b=>b.textContent);
            nextPatientStep(sel);
          } else {
            let val = document.getElementById('inp').value.trim();
            if (!val) return alert('Заполните поле');
            if (q.type==='number' && isNaN(Number(val))) return alert('Введите число');
            nextPatientStep(q.type==='number'?Number(val):val);
          }
        };
      }
    }
    window.toggleMulti = (el)=> el.classList.toggle('active');

    window.nextPatientStep = (answer)=> {
      pAns[pStep] = answer;
      pStep++;
      (pStep < patientQ.length) ? renderPatientStep() : finishPatient();
    };

    /* ---------- Завершение пациента ---------- */
    async function finishPatient() {
      code   = String(Math.floor(1000 + Math.random()*9000));
      const data = { code, createdAt: Date.now() };
      patientQ.forEach((q,i)=> data[`p${i+1}`] = pAns[i]);

      let ref;
      try {
        ref = await addDoc(collection(db,'surveys'), data);
      } catch(e){ console.error(e); return alert(e.message); }

      docId = ref.id;
      showCodeAndQR();
    }

    function showCodeAndQR() {
      html(`<div class="card text-center">
        <p class="mb-2 font-medium">ВАШ КОД</p>
        <p class="text-4xl font-bold mb-4">${code}</p>
        <canvas id="qr" class="mx-auto mb-4"></canvas>
        <p class="text-sm text-red-600 font-medium">Сохраните код и передайте врачу.<br>Не закрывайте страницу!</p>
      </div>`);

      const link = `${location.origin}${location.pathname}?role=doctor&id=${docId}`;
      new QRious({ element: document.getElementById('qr'), value: link, size: 200 });
    }

    /* ---------- Рендер врача ---------- */
    function renderAskPatientCode() {
      html(`<div class="card">
        <h2 class="text-xl font-semibold mb-4">Введите код пациента</h2>
        <input id="codeInp" class="w-full rounded-lg border px-4 py-3 mb-4" inputmode="numeric" maxlength="4" />
        ${btn('Найти')}
      </div>`);
      document.querySelector('button').onclick = async()=> {
        const c = document.getElementById('codeInp').value.trim();
        if (c.length!==4) return alert('Код = 4 цифры');
        const qSnap = await getDocs(query(collection(db,'surveys'), where('code','==',c)));
        if (qSnap.empty) return alert('Пациент не найден');
        docId = qSnap.docs[0].id;
        loadPatientForDoctor();
      };
    }

    async function loadPatientForDoctor() {
      const snap = await getDoc(doc(db,'surveys',docId));
      if (!snap.exists()) return alert('Анкета не найдена');
      const data = snap.data();
      patientQ.forEach((q,i)=> pAns[i]=data[`p${i+1}`]);
      renderDoctorStep();
    }

    function renderDoctorStep() {
      const q = doctorQ[dStep];
      let inner = `<div class="card">
        <h2 class="text-xl font-semibold mb-6">${q.label}</h2>`;

      if (q.type==='number') {
        inner+=`<input id="dinp" type="number" class="w-full rounded-lg border px-4 py-3 mb-4" />`;
        inner+=btn('Далее');
      } 
      else if (q.type==='single') {
        q.options.forEach(o=>{
          inner+=`<button class="btn-option" onclick="nextDoctorStep(${JSON.stringify(o)})">${o}</button>`;
        });
      } 
      else if (q.type==='multi') {
        q.options.forEach((o,i)=>{
          inner+=`<button class="btn-option" data-i="${i}" onclick="toggleMulti(this)">${o}</button>`;
        });
        inner+=btn('Далее (можно выбрать несколько)');
      }
      inner+=`</div>`;
      html(inner);

      if (q.type==='number' || q.type==='multi') {
        document.querySelector('button:last-of-type').onclick = ()=>{
          if (q.type==='number') {
            const v = document.getElementById('dinp').value.trim();
            if(v==='') return alert('Введите число');
            nextDoctorStep(Number(v));
          } else {
            const sel=[...document.querySelectorAll('.btn-option.active')].map(b=>b.textContent);
            nextDoctorStep(sel);
          }
        };
      }
    }

    window.nextDoctorStep = (ans)=>{
      dAns[dStep]=ans;
      dStep++;
      (dStep<doctorQ.length) ? renderDoctorStep() : saveDoctor();
    };

    /* ---------- Сохранение врача + баллы ---------- */
    function calculateScore() {
      let score=0;
      // примитивная формула
      const fever   = pAns[2];                // single
      const pain    = Number(pAns[4]);        // 0-3
      const cough   = dAns[0];                // single
      const spo2    = Number(dAns[1]);        // number
      const therapy = dAns[2];                // multi

      score += (fever==='Да, держится')?2: (fever==='Да, кратковременно')?1:0;
      score += pain;
      score += (cough==='Влажный')?4: (cough==='Сухой')?2:0;
      score += (spo2<90)?4: (spo2<95)?2:0;
      score += therapy.length;  // по 1 баллу

      return score;
    }

    async function saveDoctor() {
      const upd={ finishedAt: Date.now(), score: calculateScore() };
      doctorQ.forEach((q,i)=> upd[`d${i+1}`]=dAns[i]);
      await updateDoc(doc(db,'surveys',docId), upd);
      html(`<div class="card text-center">
        <p class="text-2xl font-semibold mb-4">Готово!</p>
        <p class="text-lg">Итоговый балл: <span class="font-bold">${upd.score}</span></p>
      </div>`);
    }

    /* ---------- Admin ---------- */
    async function initAdmin() {
      html('<div class="text-white text-lg">Загружаем…</div>');
      const snap = await getDocs(collection(db,'surveys'));
      if (snap.empty){ html('<div class="text-white">Данных нет</div>'); return; }

      const rows=[];
      let table=`<div class="card overflow-auto"><table class="w-full text-sm whitespace-nowrap"><thead><tr>`;
      const headers=['Код','ФИО','Возраст','Температура','Факторы','Боль','Кашель','SpO₂','Терапия','Баллы'];
      headers.forEach(h=> table+=`<th class="px-3 py-2 font-medium">${h}</th>`);
      table+='</tr></thead><tbody>';

      snap.forEach(docSnap=>{
        const d=docSnap.data();
        const r={
          code:d.code,
          fio:d.p1||'',
          age:d.p2||'',
          fever:d.p3||'',
          risks:(d.p4||[]).join(', '),
          pain:d.p5,
          cough:d.d1||'',
          spo2:d.d2||'',
          therapy:(d.d3||[]).join(', '),
          score:d.score??''
        };
        rows.push(r);
        table+='<tr>'+Object.values(r).map(v=>`<td class="px-3 py-1 border-t">${v}</td>`).join('')+'</tr>';
      });

      table+=`</tbody></table>
        <button id="dl" class="mt-4 w-full py-3 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Скачать Excel</button>
      </div>`;
      html(table);

      document.getElementById('dl').onclick = ()=> {
        const ws=XLSX.utils.json_to_sheet(rows,{header:Object.keys(rows[0])});
        const wb=XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,ws,'surveys');
        XLSX.writeFile(wb,'surveys.xlsx');
      };
    }

    /* ---------- Запуск ---------- */
    if (role==='patient')           renderPatientStep();
    else if (role==='doctor') {
      if (docId) loadPatientForDoctor();
      else       renderAskPatientCode();
    }
    else if (role==='admin')        initAdmin();
  </script>
</body>
</html>
