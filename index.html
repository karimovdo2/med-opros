<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å–Ω–∏–∫</title>

  <!-- ‚îÄ‚îÄ favicon / —Ü–≤–µ—Ç —Ç–µ–º—ã ‚îÄ‚îÄ -->
  <link rel="icon" type="image/png" href="./img/logo.png" />
  <link rel="apple-touch-icon" href="./img/logo.png" />
  <meta name="theme-color" content="#7c3aed" />

  <!-- ‚îÄ‚îÄ CDN‚Äë–±–∏–±–ª–∏–æ—Ç–µ–∫–∏ ‚îÄ‚îÄ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <!-- ‚îÄ‚îÄ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–ª–∑—É–Ω–∫–æ–≤ ‚îÄ‚îÄ -->
  <style>
    input[type=range].big-thumb::-webkit-slider-thumb,
    input[type=range].big-thumb::-moz-range-thumb{
      width:32px;height:32px;border-radius:50%;
      background:#4f46e5;cursor:pointer;
      box-shadow:0 0 6px rgba(0,0,0,.25)
    }
  </style>
</head>





<!-- --------------------------------------------------------------- -->
<!--                      –í–°–Ø –ª–æ–≥–∏–∫–∞ –Ω–∏–∂–µ                            -->
<!-- --------------------------------------------------------------- -->
<script type="module">
/**************** Firebase ****************/
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.11.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc,
  getDoc, updateDoc, getDocs, query, where
} from "https://www.gstatic.com/firebasejs/9.11.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:            "YOUR_API_KEY",
  authDomain:        "clinic-quiz.firebaseapp.com",
  projectId:         "clinic-quiz",
  storageBucket:     "clinic-quiz.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId:             "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/**************** –í–æ–ø—Ä–æ—Å—ã ****************/

/**************** –í–°–ï –í–û–ü–†–û–°–´ ****************/
const patientQuestions = [
  { type:"single", label:"–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –≤—Ä–∞—á–∞ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤.", options:[{ label:"–ù–∞—á–Ω—ë–º!", score:0 }] },
  { type:"single", label:"–í–∞—à –ø–æ–ª", options:[{ label:"–ú—É–∂—á–∏–Ω–∞", score:0 },{ label:"–ñ–µ–Ω—â–∏–Ω–∞", score:1 }] },
  { type:"text",   label:"–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ" },
  { type:"text",   label:"–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è" },
  { type:"text",   label:"–ü—Ä–æ—Ñ–µ—Å—Å–∏—è, –¥–æ–ª–∂–Ω–æ—Å—Ç—å" },
  { type:"slider", label:"–°—Ç–∞–∂ —Ä–∞–±–æ—Ç—ã, –ø–æ–ª–Ω—ã—Ö –ª–µ—Ç", min:0, max:99, start:10, unit:" –ª–µ—Ç" },
  { type:"slider", label:"–í–æ–∑—Ä–∞—Å—Ç", min:0, max:99, start:30, unit:" –ª–µ—Ç" },
  { type:"slider", label:"–í–µ—Å", min:30, max:200, start:70, unit:" –∫–≥" },
  { type:"slider", label:"–†–æ—Å—Ç", min:130, max:250, start:160, unit:" —Å–º" },
  { type:"single", label:"–í—ã –∫—É—Ä–∏—Ç–µ?", options:[
      { label:"–ù–µ—Ç", score:0 },
      { label:"–î–∞, –¥–æ 10 —Å–∏–≥–∞—Ä–µ—Ç/—Å—É—Ç–∫–∏", score:1 },
      { label:"–î–∞, 10‚Äì20 —Å–∏–≥–∞—Ä–µ—Ç/—Å—É—Ç–∫–∏", score:2 },
      { label:"–î–∞, –±–æ–ª–µ–µ 20 —Å–∏–≥–∞—Ä–µ—Ç/—Å—É—Ç–∫–∏", score:3 }
  ]},
  { type:"single", label:"–ò–º–µ–µ—Ç—Å—è –ª–∏ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ - —Å–∞—Ö–∞—Ä–Ω—ã–π –¥–∏–∞–±–µ—Ç 1 —Ç–∏–ø–∞?", options:[{ label:"–ù–µ—Ç", score:0 },{ label:"–î–∞", score:1 }] },
  { type:"single", label:"–ò–º–µ–µ—Ç—Å—è –ª–∏ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ - —Å–∞—Ö–∞—Ä–Ω—ã–π –¥–∏–∞–±–µ—Ç 2 —Ç–∏–ø–∞?", options:[{ label:"–ù–µ—Ç", score:0 },{ label:"–î–∞", score:1 }] },
  { type:"single", label:"–ò–º–µ–µ—Ç—Å—è –ª–∏ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ - –•–û–ë–õ?", options:[{ label:"–ù–µ—Ç", score:0 },{ label:"–î–∞", score:1 }] },
  { type:"single", label:"–ò–º–µ–µ—Ç—Å—è –ª–∏ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ - –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è —Å–µ—Ä–¥—Ü–∞/—Å–æ—Å—É–¥–æ–≤?", options:[{ label:"–ù–µ—Ç", score:0 },{ label:"–î–∞", score:1 }] },
  { type:"single", label:"–ò–º–µ–µ—Ç—Å—è –ª–∏ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ - –æ–Ω–∫–æ–ª–æ–≥–∏—è?", options:[{ label:"–ù–µ—Ç", score:0 },{ label:"–î–∞", score:1 }] },
  { type:"single", label:"–ò–º–µ–µ—Ç—Å—è –ª–∏ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ - –¥—Ä—É–≥–∏–µ —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è?", options:[{ label:"–ù–µ—Ç", score:0 },{ label:"–î–∞", score:1 }] },
  /* ‚îÄ‚îÄ –ê–ª–∫–æ–≥–æ–ª—å (AUDIT) ‚îÄ‚îÄ */
  { type:"single", label:"–ö–∞–∫ —á–∞—Å—Ç–æ –≤—ã —É–ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç–µ –Ω–∞–ø–∏—Ç–∫–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –∞–ª–∫–æ–≥–æ–ª—å?", options:[
      { label:"–ù–∏–∫–æ–≥–¥–∞", score:0 },
      { label:"–†–µ–∂–µ —Ä–∞–∑–∞ –≤ –º–µ—Å—è—Ü", score:1 },
      { label:"–†–∞–∑ –≤ –º–µ—Å—è—Ü", score:2 },
      { label:"–†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é", score:3 },
      { label:"–ö–∞–∂–¥—ã–π –∏–ª–∏ –ø–æ—á—Ç–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å", score:4 },
  ]},
  { type:"single", label:"–°–∫–æ–ª—å–∫–æ –µ–¥–∏–Ω–∏—Ü –∞–ª–∫–æ–≥–æ–ª—è –≤—ã –æ–±—ã—á–Ω–æ –≤—ã–ø–∏–≤–∞–µ—Ç–µ –∑–∞ –æ–¥–∏–Ω –ø—Ä–∏—ë–º?", options:[
      { label:"–¥–æ 2", score:0 },{ label:"3-4", score:1 },{ label:"5-6", score:2 },
      { label:"7-9", score:3 },{ label:"10 –∏ –±–æ–ª–µ–µ", score:4 }
  ]},
  { type:"single", label:"–ö–∞–∫ —á–∞—Å—Ç–æ –≤—ã –≤—ã–ø–∏–≤–∞–µ—Ç–µ 6 –∏ –±–æ–ª–µ–µ –µ–¥–∏–Ω–∏—Ü –∑–∞ —Ä–∞–∑?", options:[
      { label:"–ù–∏–∫–æ–≥–¥–∞", score:0 },{ label:"–†–µ–∂–µ —Ä–∞–∑–∞ –≤ –º–µ—Å—è—Ü", score:1 },
      { label:"–†–∞–∑ –≤ –º–µ—Å—è—Ü", score:2 },{ label:"–†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é", score:3 },
      { label:"–ö–∞–∂–¥—ã–π –∏–ª–∏ –ø–æ—á—Ç–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å", score:4 }
  ]},
  { type:"single", label:"–ö–∞–∫ —á–∞—Å—Ç–æ –∑–∞ 12 –º–µ—Å—è—Ü–µ–≤ –ø—Ä–∏ —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏ –∞–ª–∫–æ–≥–æ–ª—è –≤—ã –Ω–µ –º–æ–≥–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è?", options:[
      { label:"–ù–∏–∫–æ–≥–¥–∞", score:0 },{ label:"–†–µ–∂–µ —Ä–∞–∑–∞ –≤ –º–µ—Å—è—Ü", score:1 },
      { label:"–†–∞–∑ –≤ –º–µ—Å—è—Ü", score:2 },{ label:"–†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é", score:3 },
      { label:"–ö–∞–∂–¥—ã–π –∏–ª–∏ –ø–æ—á—Ç–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å", score:4 }
  ]},
  { type:"single", label:"–ö–∞–∫ —á–∞—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–ª–∏ –¥–µ–ª–∞ –∏–∑-–∑–∞ –≤—ã–ø–∏–≤–∫–∏?", options:[
      { label:"–ù–∏–∫–æ–≥–¥–∞", score:0 },{ label:"–†–µ–∂–µ —Ä–∞–∑–∞ –≤ –º–µ—Å—è—Ü", score:1 },
      { label:"–†–∞–∑ –≤ –º–µ—Å—è—Ü", score:2 },{ label:"–†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é", score:3 },
      { label:"–ö–∞–∂–¥—ã–π –∏–ª–∏ –ø–æ—á—Ç–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å", score:4 }
  ]},
  { type:"single", label:"–ö–∞–∫ —á–∞—Å—Ç–æ –æ–ø–æ—Ö–º–µ–ª–∏–≤–∞–ª–∏—Å—å?", options:[
      { label:"–ù–∏–∫–æ–≥–¥–∞", score:0 },{ label:"–†–µ–∂–µ —Ä–∞–∑–∞ –≤ –º–µ—Å—è—Ü", score:1 },
      { label:"–†–∞–∑ –≤ –º–µ—Å—è—Ü", score:2 },{ label:"–†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é", score:3 },
      { label:"–ö–∞–∂–¥—ã–π –∏–ª–∏ –ø–æ—á—Ç–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å", score:4 }
  ]},
  { type:"single", label:"–ö–∞–∫ —á–∞—Å—Ç–æ –±—ã–ª–æ —á—É–≤—Å—Ç–≤–æ –≤–∏–Ω—ã –ø–æ—Å–ª–µ –∞–ª–∫–æ–≥–æ–ª—è?", options:[
      { label:"–ù–∏–∫–æ–≥–¥–∞", score:0 },{ label:"–†–µ–∂–µ —Ä–∞–∑–∞ –≤ –º–µ—Å—è—Ü", score:1 },
      { label:"–†–∞–∑ –≤ –º–µ—Å—è—Ü", score:2 },{ label:"–†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é", score:3 },
      { label:"–ö–∞–∂–¥—ã–π –∏–ª–∏ –ø–æ—á—Ç–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å", score:4 }
  ]},
  { type:"single", label:"–ö–∞–∫ —á–∞—Å—Ç–æ –Ω–µ –ø–æ–º–Ω–∏–ª–∏ –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ –ø–æ—Å–ª–µ –∞–ª–∫–æ–≥–æ–ª—è?", options:[
      { label:"–ù–∏–∫–æ–≥–¥–∞", score:0 },{ label:"–†–µ–∂–µ —Ä–∞–∑–∞ –≤ –º–µ—Å—è—Ü", score:1 },
      { label:"–†–∞–∑ –≤ –º–µ—Å—è—Ü", score:2 },{ label:"–†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é", score:3 },
      { label:"–ö–∞–∂–¥—ã–π –∏–ª–∏ –ø–æ—á—Ç–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å", score:4 }
  ]},
  { type:"single", label:"–ü—Ä–∏—á–∏–Ω—è–ª–∏ —Å–µ–±–µ –∏–ª–∏ –¥—Ä—É–≥–∏–º —Ç—Ä–∞–≤–º—ã –≤ —Å–≤—è–∑–∏ —Å –∞–ª–∫–æ–≥–æ–ª–µ–º?", options:[
      { label:"–ù–∏–∫–æ–≥–¥–∞", score:0 },{ label:"–†–µ–∂–µ —Ä–∞–∑–∞ –≤ –º–µ—Å—è—Ü", score:1 },
      { label:"–†–∞–∑ –≤ –º–µ—Å—è—Ü", score:2 },{ label:"–†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é", score:3 },
      { label:"–ö–∞–∂–¥—ã–π –∏–ª–∏ –ø–æ—á—Ç–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å", score:4 }
  ]},
  { type:"single", label:"–°–æ–≤–µ—Ç–æ–≤–∞–ª–∏ –ª–∏ –≤–∞–º —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∏ –∏–ª–∏ –≤—Ä–∞—á–∏ –º–µ–Ω—å—à–µ –ø–∏—Ç—å?", options:[
      { label:"–ù–∏–∫–æ–≥–¥–∞", score:0 },
      { label:"–î–∞, –±–æ–ª–µ–µ 12 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥", score:4 },
      { label:"–î–∞, –≤ —Ç–µ—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 12 –º–µ—Å—è—Ü–µ–≤", score:2 }
  ]},
  { type:"single", label:"–°–ø–∞—Å–∏–±–æ! –ü–µ—Ä–µ–¥–∞–π—Ç–µ –≤—Ä–∞—á—É.", options:[{ label:"–ì–æ—Ç–æ–≤–æ", score:0 }] }
];

const doctorQuestions = [
  { type:"slider", label:"SpO‚ÇÇ (%)",               min:0, max:100, start:96, unit:" %",         scoreFormula:v=>v<95?2:0 },
  { type:"slider", label:"–û–∫—Ä—É–∂–Ω–æ—Å—Ç—å —Ç–∞–ª–∏–∏, —Å–º",   min:0, max:200, start:70, unit:" —Å–º",        scoreFormula:v=>v<95?2:0 },
  { type:"slider", label:"–°–∏—Å—Ç–æ–ª–∏—á–µ—Å–∫–æ–µ –ê–î, –º–º —Ä—Ç. —Å—Ç.", min:0, max:240, start:120, unit:" –º–º —Ä—Ç. —Å—Ç.", scoreFormula:v=>v<140?0:2 },
  { type:"slider", label:"–î–∏–∞—Å—Ç–æ–ª–∏—á–µ—Å–∫–æ–µ –ê–î, –º–º —Ä—Ç. —Å—Ç.", min:0, max:200, start:80,  unit:" –º–º —Ä—Ç. —Å—Ç.", scoreFormula:v=>v<90?0:2 },
  { type:"slider", label:"–•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω, –º–º–æ–ª—å/–ª",    min:0, max:20,  start:4,  unit:" –º–º–æ–ª—å/–ª",   scoreFormula:v=>v<5.2?0:2 }
];

/* ---------- –ø–æ—Ä—è–¥–æ–∫ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã / Excel ---------- */
const patientKeys = Array.from({ length: patientQuestions.length },
                               (_, i) => `p${i + 1}`);
const doctorKeys  = Array.from({ length: doctorQuestions.length },
                               (_, i) => `d${i + 1}`);

const calcKeys = [
  "score",
  "bmi", "bmiInfo",
  "chol", "cholInfo",
  "sbp", "dbp", "bpInfo",
  "smokeText",
  "chronicList",
  "alcSum", "alcInfo",
  "group"
];

const columns = [
  "id",          // id –¥–æ–∫—É–º–µ–Ω—Ç–∞ Firestore
  "createdAt",   // —à—Ç–∞–º–ø –≤—Ä–µ–º–µ–Ω–∏
  ...patientKeys,
  ...doctorKeys,
  ...calcKeys
];


/**************** DOM helpers ****************/
const root      = document.body;
const baseInput = "w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg";
const card      = () => { const d=document.createElement("div"); d.className="max-w-lg w-full bg-white/80 backdrop-blur rounded-xl p-6 mx-auto mt-12 shadow-xl"; return d; };
const makeBtn   = t => {
  const b=document.createElement("button");
  b.textContent=t;
  b.className="w-full py-3 mt-4 rounded-lg text-lg font-semibold text-white bg-[#6699ff] hover:bg-[#5c8fe6] transition";
  return b;
};
const header = (i,t) => { const h=document.createElement("h2"); h.className="text-2xl font-semibold mb-6 text-center"; h.textContent=`–®–∞–≥ ${i+1} –∏–∑ ${t}`; return h; };
const label  = t       => { const p=document.createElement("p"); p.className="text-xl font-medium mb-4"; p.textContent=t; return p; };
const genCode= ()      => String(Math.floor(1000+Math.random()*9000));

/* –∞–ª–∏–∞—Å—ã –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞ –≤—Ä–∞—á–∞ */
const qLabel = label, bigBtn = makeBtn;

/**************** Widgets ****************/
function sliderWidget(q){
  const num   = document.createElement("input");
  num.type    = "number";
  num.min     = q.min;
  num.max     = q.max;
  num.value   = q.start ?? q.min;
  num.className = baseInput;

  const big  = document.createElement("div");
  big.className = "flex justify-center my-4 text-4xl font-bold";
  const span = document.createElement("span");
  span.textContent = num.value + (q.unit||"");
  big.appendChild(span);

  const range = document.createElement("input");
  range.type  = "range";
  range.min   = q.min;
  range.max   = q.max;
  range.value = num.value;
  range.className = "w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer big-thumb";

  const sync = v => { num.value=v; range.value=v; span.textContent=v+(q.unit||""); };
  num.oninput   = () => sync(Math.max(q.min,Math.min(q.max,Number(num.value)||q.min)));
  range.oninput = () => sync(range.value);

  const wrap = document.createElement("div");
  wrap.append(num,big,range);
  return {wrap,val:()=>Number(range.value)};
}

function emojiWidget(char, base) {
  let v = 3;

  const num = document.createElement("input");
  num.type  = "number";
  num.min   = 1;
  num.max   = 5;
  num.value = v;
  num.className = baseInput;

  const scale = document.createElement("div");
  scale.className = "flex justify-between items-end my-4";

  for (let i = 1; i <= 5; i++) {
    const col = document.createElement("div");
    col.className = "flex flex-col items-center";

    const e = document.createElement("span");
    e.textContent = char;
    e.style.fontSize = `${base + i * 0.3}rem`;   // ‚Üê –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

    const s = document.createElement("span");
    s.textContent = i;
    s.className   = "text-sm mt-1";

    col.append(e, s);
    scale.appendChild(col);
  }

  const range = document.createElement("input");
  range.type  = "range";
  range.min   = 1;
  range.max   = 5;
  range.value = v;
  range.className = "w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer big-thumb";

  const sync = x => { v = x; num.value = x; range.value = x; };
  num.oninput   = () => sync(Math.max(1, Math.min(5, Number(num.value) || 1)));
  range.oninput = () => sync(range.value);

  const wrap = document.createElement("div");
  wrap.append(num, scale, range);
  return { wrap, val: () => v };
}




/******************* PATIENT *******************/
async function initPatient () {
  const ans = []; let step = 0;
  const box = card(); root.appendChild(box); render();

  function render () {
    box.innerHTML = "";
    const q = patientQuestions[step];
    box.append(header(step,patientQuestions.length));

    const w=document.createElement("div"); w.className="mb-6"; w.append(label(q.label));
    let widget, selections=[];

    /* text */
    if (q.type==="text") {
      const inp=document.createElement("input");
      inp.className=baseInput; w.append(inp);
      const next=makeBtn("–î–∞–ª–µ–µ");
      next.onclick=()=>{const v=inp.value.trim(); if(!v)return alert("–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ"); ans.push(v); advance();};
      box.append(w,next);
    }
    /* slider / number */
    else if (["slider","number","age"].includes(q.type)) {
      widget=sliderWidget(q); w.append(widget.wrap);
      const next=makeBtn("–î–∞–ª–µ–µ"); next.onclick=()=>{ans.push(widget.val()); advance();};
      box.append(w,next);
    }
    /* single */
    else if (q.type==="single") {
      const cont=document.createElement("div");
      q.options.forEach((o,i)=>{
        const b=makeBtn(o.label); b.classList.add("mb-3");
        b.onclick=()=>{ans.push(i); advance();};
        cont.appendChild(b);
      });
      w.append(cont); box.append(w);
    }
    /* multi */
    else if (q.type==="multi") {
      w.append(noteMulti());
      const cont=document.createElement("div");
      q.options.forEach((o,i)=>{
        const b=makeBtn(o.label); b.className="w-full mb-3 py-3 rounded-lg border text-lg hover:bg-emerald-50";
        b.onclick=()=>{ selections.includes(i)?(selections=selections.filter(x=>x!==i),b.classList.remove("bg-emerald-200"))
                                         :(selections.push(i),b.classList.add("bg-emerald-200"));};
        cont.appendChild(b);
      });
      w.append(cont);
      const next=makeBtn("–î–∞–ª–µ–µ"); next.onclick=()=>{ans.push(selections); advance();};
      box.append(w,next);
    }
    /* pain / emoji */
    else if (q.type==="pain")  { widget=emojiWidget("üî•",1); w.append(widget.wrap); const n=makeBtn("–î–∞–ª–µ–µ"); n.onclick=()=>{ans.push(widget.val()); advance();}; box.append(w,n);}
    else if (q.type==="emoji") { widget=emojiWidget("üòä",0.8); w.append(widget.wrap); const n=makeBtn("–î–∞–ª–µ–µ"); n.onclick=()=>{ans.push(widget.val()); advance();}; box.append(w,n);}
  }

  function advance () { step++; step<patientQuestions.length ? render() : finish(); }

  async function finish () {
    const code = genCode();
    const data = { code, createdAt: Date.now() };
    patientQuestions.forEach((_,i)=>data[`p${i+1}`]=ans[i]);
    const ref = await addDoc(collection(db,"surveys"), data);
    showQr(code, ref.id);
  }
}

/************ QR –ø–æ—Å–ª–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ************/
function showQr (code,id) {
  root.innerHTML="";
  const c=card();
  c.innerHTML=`<p class="text-center text-xl mb-4">–í–∞—à
      <span class='font-bold text-5xl block my-2'>${code}</span><br>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–æ–º–µ—Ä –∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ –≤—Ä–∞—á—É</p>`;
  const link=`${location.origin}${location.pathname}?role=doctor&id=${id}`;
  const canvas=document.createElement("canvas");
  new QRious({element:canvas,value:link,size:220});
  const a=document.createElement("a");
  a.href=link; a.textContent=link; a.className="block text-center text-indigo-600 underline mt-4 break-all";
  c.append(canvas,a); root.append(c);
}

/******************* DOCTOR *******************/
async function initDoctor () {
  const u=new URL(location.href);
  const id=u.searchParams.get("id");
  id ? renderDoctor(id) : renderDoctorSearch();
}

function renderDoctorSearch () {
  const c=card(); c.append(label("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–∞—Ü–∏–µ–Ω—Ç–∞:"));
  const inp=document.createElement("input"); inp.maxLength=4; inp.className=baseInput;
  const btn=makeBtn("–ù–∞–π—Ç–∏");
  btn.onclick=async()=>{
    if(inp.value.length!==4) return alert("–ö–æ–¥ –∏–∑ 4 —Ü–∏—Ñ—Ä");
    const q=query(collection(db,"surveys"), where("code","==", inp.value));
    const qs=await getDocs(q);
    if(qs.empty) return alert("–ê–Ω–∫–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
    location.href=`${location.pathname}?role=doctor&id=${qs.docs[0].id}`;
  };
  c.append(inp,btn); root.append(c);
}

async function renderDoctor (id) {
  const dSnap=await getDoc(doc(db,"surveys",id));
  if(!dSnap.exists()) return alert("–ê–Ω–∫–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

  const docData=dSnap.data();
  const answers=[]; let step=0;
  const box=card(); root.append(box); render();

  function render () {
    box.innerHTML="";
    if(step===0){ const h=qLabel(`–ö–æ–¥ –ø–∞—Ü–∏–µ–Ω—Ç–∞: ${docData.code}`); h.classList.add("text-center"); box.append(h); }

    if(step>=doctorQuestions.length){ finish(); return; }

    const q=doctorQuestions[step];
    const wrap=document.createElement("div"); wrap.className="mb-6"; wrap.append(qLabel(q.label));
    let sliderObj,selections=[];
    if(q.type==="slider"){
      sliderObj=sliderWidget(q); wrap.append(sliderObj.wrap);
      const n=makeBtn("–î–∞–ª–µ–µ"); n.onclick=()=>{answers.push(sliderObj.val()); step++; render();};
      box.append(wrap,n);
    }
    else if(q.type==="single"){
      const cont=document.createElement("div");
      q.options.forEach((o,i)=>{
        const b=makeBtn(o.label); b.className="w-full mb-3 py-3 rounded-lg border text-lg hover:bg-indigo-50";
        b.onclick=()=>{answers.push(i); step++; render();};
        cont.append(b);
      });
      wrap.append(cont); box.append(wrap);
    }
    else if(q.type==="multi"){
      wrap.append(noteMulti());
      const cont=document.createElement("div");
      q.options.forEach((o,i)=>{
        const b=makeBtn(o.label); b.className="w-full mb-3 py-3 rounded-lg border text-lg hover:bg-emerald-50";
        b.onclick=()=>{selections.includes(i)?(selections.splice(selections.indexOf(i),1),b.classList.remove("bg-emerald-200"))
                                         :(selections.push(i),b.classList.add("bg-emerald-200"));};
        cont.append(b);
      });
      wrap.append(cont);
      const n=makeBtn("–î–∞–ª–µ–µ"); n.onclick=()=>{answers.push(selections); step++; render();};
      box.append(wrap,n);
    }
  }

  async function finish () {
    /* –æ—Ç–≤–µ—Ç—ã –≤—Ä–∞—á–∞ */
    const upd={}; doctorQuestions.forEach((_,i)=>upd[`d${i+1}`]=answers[i]);
    upd.score      = calcTotal({...docData,...upd});
    upd.finishedAt = Date.now();

    /* –≤—ã—á–∏—Å–ª–µ–Ω–∏—è */
    const w  = docData.p8, h = docData.p9/100;
    const bmi=(w/(h*h)).toFixed(1);
    const bmiInfo = bmi<18.5?"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –≤–µ—Å":bmi<25?"–ù–æ—Ä–º–∞–ª—å–Ω—ã–π –≤–µ—Å":
                     bmi<30 ?"–ò–∑–±—ã—Ç–æ—á–Ω—ã–π –≤–µ—Å"   :"–û–∂–∏—Ä–µ–Ω–∏–µ ‚Äî —Ñ–∞–∫—Ç–æ—Ä —Ä–∏—Å–∫–∞";

    const chol     = upd.d5;
    const cholInfo = chol<5.2?"–ù–æ—Ä–º–∞":chol<8?"–ü–æ–≥—Ä–∞–Ω–∏—á–Ω–æ –ø–æ–≤—ã—à–µ–Ω":"–í—ã—Å–æ–∫–∏–π ‚Äî —Ñ–∞–∫—Ç–æ—Ä —Ä–∏—Å–∫–∞";

    const sbp=upd.d3, dbp=upd.d4;
    const bpInfo   = (sbp<120&&dbp<80)?"–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ":
                     (sbp<130&&dbp<85)?"–ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ":
                     (sbp<140||dbp<90)?"–ü–æ–≥—Ä–∞–Ω–∏—á–Ω–∞—è –≥–∏–ø–µ—Ä—Ç–µ–Ω–∑–∏—è":"–ì–∏–ø–µ—Ä—Ç–µ–Ω–∑–∏—è";

    const smokeIdx  = docData.p10;
    const smokeText = patientQuestions[9].options[smokeIdx].label + (smokeIdx>0?" ‚Äî —Ñ–∞–∫—Ç–æ—Ä —Ä–∏—Å–∫–∞":"");

    const chronicIdx=[11,12,13,14,15], chronicNames=["–î–∏–∞–±–µ—Ç 1","–î–∏–∞–±–µ—Ç 2","–•–û–ë–õ","–°–°–ó","–û–Ω–∫–æ–ª–æ–≥–∏—è"];
    const chronicList=chronicIdx.map((q,i)=>docData[`p${q}`]===1?chronicNames[i]:null).filter(Boolean);

    const alcIdx=[16,17,18,19,20,21,22,23,24,25];
    let alcSum=0; alcIdx.forEach(i=>alcSum+=patientQuestions[i-1].options[docData[`p${i}`]].score);
    const alcInfo = alcSum>=15?"–í—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏":alcSum>=8?"–ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —Ä–∏—Å–∫":"–†–∏—Å–∫ –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π";

    /* –≥—Ä—É–ø–ø–∞ */
    let group;
    if(chronicList.length>0)                group="3–ê";
    else if(docData.p16===1)                group="3–ë";
    else if(docData.p7>65)                  group="2";
    else if(bmi>=30||chol>=8||sbp>=140||dbp>=90||smokeIdx>0||alcSum>=8) group="2";
    else                                    group="1";

    Object.assign(upd,{bmi:+bmi,bmiInfo,chol,cholInfo,sbp,dbp,bpInfo,
                       smokeText,chronicList:chronicList.join(", "),
                       alcSum,alcInfo,group});

    await updateDoc(doc(db,"surveys",id), upd);

    /* –≤—ã–≤–æ–¥ –≤—Ä–∞—á—É */
    box.innerHTML="";
    const out=document.createElement("div"); out.className="space-y-2 text-left";
    [
      `–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª: ${upd.score}`,
      `–ò–ú–¢: ${bmi} (${bmiInfo})`,
      `–•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω: ${chol} –º–º–æ–ª—å/–ª (${cholInfo})`,
      `–ê–î: ${sbp}/${dbp} –º–º —Ä—Ç.—Å—Ç. (${bpInfo})`,
      `–ö—É—Ä–µ–Ω–∏–µ: ${smokeText}`,
      `–•—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è: ${chronicList.join(", ")||"–Ω–µ—Ç"}`,
      `–ê–ª–∫–æ–≥–æ–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å (AUDIT): ${alcSum} (${alcInfo})`,
      `–ì—Ä—É–ø–ø–∞ –∑–¥–æ—Ä–æ–≤—å—è: ${group}`
    ].forEach(t=>{const p=document.createElement("p"); p.className="px-4 py-2 bg-white/50 rounded"; p.textContent=t; out.append(p);});
    box.append(out);
  }
}

/******************* ADMIN *******************/
async function initAdmin () {
  const snap=await getDocs(collection(db,"surveys"));
  if(snap.empty){ showMsg("–ù–µ—Ç –∞–Ω–∫–µ—Ç"); return; }
  const rows=[]; snap.forEach(d=>rows.push({id:d.id,...d.data()}));
  renderTable(rows);
}
function flat (v) {
  const row = {};
  columns.forEach(k => {               // –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–ª–∏—á–∏–µ –∏ –ø–æ—Ä—è–¥–æ–∫
    row[k] = v[k] ?? "";
  });

  // –ø—Ä–∏–º–µ—Ä ¬´–∫—Ä–∞—Å–∏–≤–æ–π¬ª –¥–∞—Ç—ã –≤–º–µ—Å—Ç–æ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥
  if (row.createdAt) {
    row.createdAt = new Date(+row.createdAt).toLocaleString();
  }

  return row;
}
function showMsg (txt){ const c=card(); c.textContent=txt; c.className+=" text-center text-red-600"; root.append(c); }

function renderTable (arr) {
  const c   = card();
  const tbl = document.createElement("table");
  tbl.className = "min-w-full text-xs md:text-sm border";

  /* ---- —à–∞–ø–∫–∞ ---- */
  const thead = document.createElement("thead");
  const hr    = document.createElement("tr");
  columns.forEach(k => {
    const th = document.createElement("th");
    th.textContent = k;
    th.className   = "border px-2 py-1 bg-gray-100 sticky top-0";
    hr.appendChild(th);
  });
  thead.appendChild(hr);
  tbl.appendChild(thead);

  /* ---- —Ç–µ–ª–æ ---- */
  const tbody = document.createElement("tbody");
  arr.forEach(r => {
    const tr = document.createElement("tr");
    columns.forEach(k => {
      const td = document.createElement("td");
      td.textContent = r[k];
      td.className   = "border px-2 py-1";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);

  /* ---- —ç–∫—Å–ø–æ—Ä—Ç Excel ---- */
  const btn = makeBtn("–°–∫–∞—á–∞—Ç—å Excel","emerald");
  btn.onclick = () => {
    const ws = XLSX.utils.json_to_sheet(arr, { header: columns });
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Surveys");
    XLSX.writeFile(wb, "surveys.xlsx");
  };

  c.append(tbl, btn);
  root.appendChild(c);
}


/******************* –°—É–º–º–∞—Ä–Ω—ã–π —Å—á—ë—Ç *******************/
function calcTotal (d){
  let t=0;
  patientQuestions.forEach((q,i)=>{const a=d[`p${i+1}`];
    if(q.type==="slider")            t+=(q.scorePerVal||0)*a;
    if(q.type==="single" && a!=null) t+=q.options[a].score;
    if(q.type==="multi"  && Array.isArray(a)) a.forEach(x=>t+=q.options[x].score);
  });
  doctorQuestions.forEach((q,i)=>{const a=d[`d${i+1}`];
    if(q.type==="slider")            t+=q.scoreFormula?q.scoreFormula(a):0;
    if(q.type==="single" && a!=null) t+=q.options[a].score;
    if(q.type==="multi"  && Array.isArray(a)) a.forEach(x=>t+=q.options[x].score);
  });
  return t;
}

/******************* ROUTER *******************/
const role=new URL(location.href).searchParams.get("role") || "patient";
if(role==="patient")      initPatient();
else if(role==="doctor")  initDoctor();
else if(role==="admin")   initAdmin();
</script>

<body class="min-h-screen p-4"
      style="background:linear-gradient(135deg,#ffffff 0%,#99ccff 100%); color:#333399;">
  <header class="w-full flex justify-center mt-6">
    <img src="./img/logo.png" alt="Med‚Äë–æ–ø—Ä–æ—Å"
         class="w-24 h-24 select-none pointer-events-none" />
  </header>
</body>
</html>
