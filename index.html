<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ú–µ–¥-–æ–ø—Ä–æ—Å</title>
<link rel="icon" href="data:,"><!-- –ø—É—Å—Ç–∞—è –∏–∫–æ–Ω–∫–∞ -->
<!-- Tailwind CDN (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å, —Ä–∞–∑–º–µ—Ä –Ω–µ–±–æ–ª—å—à–æ–π) -->
<script src="https://cdn.tailwindcss.com?plugins=typography"></script>

<!-- Firebase (modular SDK v9) -->
<script type="module">
/*-------------------------------------------------------
  1.  üîß  –í–°–¢–ê–í–¨–¢–ï –°–í–û–ô firebaseConfig
-------------------------------------------------------*/
const firebaseConfig = {
  apiKey: "###",
  authDomain: "###",
  projectId: "###",
  storageBucket: "clinic-quiz.appspot.com",
  messagingSenderId: "###",
  appId: "###"
};

/*-------------------------------------------------------
  2.  –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
-------------------------------------------------------*/
import { initializeApp }  from "https://www.gstatic.com/firebasejs/9.11.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc, getDoc, getDocs, query, where,
  updateDoc
} from "https://www.gstatic.com/firebasejs/9.11.0/firebase-firestore.js";
import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.19.3/+esm";

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/*-------------------------------------------------------
  3.  –î–ê–ù–ù–´–ï –í–û–ü–†–û–°–û–í
-------------------------------------------------------*/
const patientQuestions = [
  {type:"text",  label:"–§–∞–º–∏–ª–∏—è, –∏–º—è, –æ—Ç—á–µ—Å—Ç–≤–æ"},
  {type:"number",label:"–í–æ–∑—Ä–∞—Å—Ç, –ª–µ—Ç"},
  {type:"single",label:"–ë—ã–ª–∞ –ª–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ > 38 ‚ÑÉ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—É—Ç–∫–∏?",
    options:["–ù–µ—Ç","–î–∞, –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–æ","–î–∞, –¥–µ—Ä–∂–∏—Ç—Å—è"]},
  {type:"multi", label:"–û—Ç–º–µ—Ç—å—Ç–µ —Ñ–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞",
    options:["–ö—É—Ä–µ–Ω–∏–µ","–ê—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–∞—è –≥–∏–ø–µ—Ä—Ç–µ–Ω–∑–∏—è","–°–∞—Ö–∞—Ä–Ω—ã–π –¥–∏–∞–±–µ—Ç","–•–û–ë–õ"]},
  {type:"single",label:"–û—Ü–µ–Ω–∏—Ç–µ –±–æ–ª—å –ø–æ —à–∫–∞–ª–µ 0‚Äì10",
    options:["0","1","2","3","4","5","6","7","8","9","10"]}
];

const doctorQuestions = [
  {type:"single",label:"–ï—Å—Ç—å –ª–∏ –∫–∞—à–µ–ª—å?",
    options:["–ù–µ—Ç","–°—É—Ö–æ–π","–í–ª–∞–∂–Ω—ã–π"]},
  {type:"single",label:"SpO‚ÇÇ –ø–æ –ø—É–ª—å—Å–æ–∫—Å–∏–º–µ—Ç—Ä—É",
    options:["‚â• 95 %","90 ‚Äì 94 %","< 90 %"]},
  {type:"multi", label:"–ù–∞–∑–Ω–∞—á–µ–Ω–æ –ª–µ—á–µ–Ω–∏–µ",
    options:["–ê–Ω—Ç–∏–±–∏–æ—Ç–∏–∫","–ñ–∞—Ä–æ–ø–æ–Ω–∏–∂–∞—é—â–µ–µ","–ò–Ω–≥–∞–ª—è—Ü–∏–∏","–ì–æ—Å–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è"]}
];

/*-------------------------------------------------------
  4.  –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
-------------------------------------------------------*/
let role = new URLSearchParams(location.search).get("role") || "patient";
let docId = new URLSearchParams(location.search).get("id");
let code;                               // 4-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
let step = 0;                           // –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
let patientAnswers = [];
let doctorAnswers  = [];

/*-------------------------------------------------------
  5.  –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
-------------------------------------------------------*/
const $ = sel => document.querySelector(sel);

function generateCode(){
  return Math.floor(1000 + Math.random()*9000).toString();
}

// –≤–µ—Å–∞ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
function calculateScore(pA, dA){
  let score = 0;
  // —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
  if(pA[2] === 1) score += 1;     // –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
  if(pA[2] === 2) score += 2;     // –¥–µ—Ä–∂–∏—Ç—Å—è
  // –±–æ–ª—å
  score += parseInt(pA[4] || 0);
  // –∫–∞—à–µ–ª—å
  if(dA[0] === 1) score += 2;
  if(dA[0] === 2) score += 4;
  // SpO2
  if(dA[1] === 1) score += 2;
  if(dA[1] === 2) score += 4;
  // –∫–∞–∂–¥–æ–µ –ª–µ—á–µ–Ω–∏–µ +1
  if(Array.isArray(dA[2])) score += dA[2].length;
  return score;
}

/*-------------------------------------------------------
  6.  –†–ï–ù–î–ï–† –ü–ê–¶–ò–ï–ù–¢–ê
-------------------------------------------------------*/
function renderPatientStep(){
  const q = patientQuestions[step];
  $("#title").textContent = q.label;
  $("#options").innerHTML = "";
  $("#hint").classList.add("hidden");
  $("#inputText").classList.add("hidden");
  $("#nextBtn").classList.add("hidden");

  if(q.type === "text" || q.type === "number"){
    $("#inputText").type = q.type==="number" ? "number" : "text";
    $("#inputText").value = "";
    $("#inputText").classList.remove("hidden");
    $("#nextBtn").textContent = "–î–∞–ª–µ–µ";
    $("#nextBtn").classList.remove("hidden");
    $("#inputText").focus();
  }

  if(q.type === "single" || q.type === "multi"){
    if(q.type==="multi"){
      $("#hint").classList.remove("hidden");
      $("#nextBtn").textContent = "–î–∞–ª–µ–µ (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)";
      $("#nextBtn").classList.remove("hidden");
    }
    q.options.forEach((opt,i)=>{
      const btn = document.createElement("button");
      btn.className = "btn-option w-full my-1";
      btn.textContent = opt;
      btn.onclick = ()=>selectOption(i,btn,q.type);
      $("#options").append(btn);
    });
  }
}

function selectOption(idx,btn,type){
  if(type==="single"){
    patientAnswers[step] = idx;
    advance();
  }else{ // multi
    btn.classList.toggle("bg-indigo-600");
    const arr = patientAnswers[step] || [];
    const pos = arr.indexOf(idx);
    if(pos>-1) arr.splice(pos,1); else arr.push(idx);
    patientAnswers[step] = arr;
  }
}

$("#nextBtn").onclick = ()=>{
  const q = patientQuestions[step];
  if(q.type==="text" || q.type==="number"){
    const val = $("#inputText").value.trim();
    if(!val) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ");
    if(q.type==="number" && isNaN(val)) return alert("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ");
    patientAnswers[step] = q.type==="number" ? Number(val) : val;
  }
  advance();
};

function advance(){
  step++;
  if(step < patientQuestions.length){
    renderPatientStep();
  }else{
    finishPatient();
  }
}

async function finishPatient(){
  const docData = { code, createdAt: Date.now() };
  patientQuestions.forEach((q,i)=>docData[`p${i+1}`]=patientAnswers[i]);
  try{
    const ref = await addDoc(collection(db,"surveys"),docData);
    docId = ref.id;
    showDoctorLink();
  }catch(e){ console.error(e); alert(e.message);}
}

function showDoctorLink(){
  $("#quiz").classList.add("hidden");
  $("#result").classList.remove("hidden");
  $("#showCode").textContent = code;
  const link = `${location.origin}${location.pathname}?role=doctor&id=${docId}`;
  new QRious({element:$("#qr"),value:link,size:200});
  $("#qrLink").href = link;
  $("#qrLink").textContent = link;
}

/*-------------------------------------------------------
  7.  –†–ï–ù–î–ï–† –î–û–ö–¢–û–†–ê
-------------------------------------------------------*/
async function initDoctor(){
  if(docId){
    const snap = await getDoc(doc(db,"surveys",docId));
    if(!snap.exists()){ return alert("–ê–Ω–∫–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"); }
    patientAnswers = patientQuestions.map((q,i)=>snap.data()[`p${i+1}`]);
    renderDoctorStep();
  }else{
    $("#doctorStart").classList.remove("hidden");
  }
}

$("#findByCodeBtn").onclick = async ()=>{
  const c = $("#doctorCode").value.trim();
  if(c.length!==4) return alert("–í–≤–µ–¥–∏—Ç–µ 4 —Ü–∏—Ñ—Ä—ã");
  const qSnap = await getDocs(query(collection(db,"surveys"),where("code","==",c)));
  if(qSnap.empty) return alert("–ü–∞—Ü–∏–µ–Ω—Ç —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω");
  const snap = qSnap.docs[0]; docId = snap.id;
  patientAnswers = patientQuestions.map((q,i)=>snap.data()[`p${i+1}`]);
  $("#doctorStart").classList.add("hidden");
  renderDoctorStep();
};

function renderDoctorStep(){
  const idx = doctorAnswers.length;
  if(idx===0){ renderPatientSummary(); }
  if(idx < doctorQuestions.length){
    const q = doctorQuestions[idx];
    $("#dTitle").textContent = q.label;
    $("#dOptions").innerHTML = "";
    $("#dHint").classList.add("hidden");
    $("#dInput").classList.add("hidden");
    $("#dNext").classList.add("hidden");

    if(q.type==="single" || q.type==="multi"){
      if(q.type==="multi"){
        $("#dHint").classList.remove("hidden");
        $("#dNext").textContent = "–î–∞–ª–µ–µ (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)";
        $("#dNext").classList.remove("hidden");
      }
      q.options.forEach((opt,i)=>{
        const b=document.createElement("button");
        b.className="btn-option w-full my-1";
        b.textContent=opt;
        b.onclick=()=>selectDoctorOption(i,b,q.type);
        $("#dOptions").append(b);
      });
    }
    if(q.type==="number"){
      $("#dInput").type="number";
      $("#dInput").value="";
      $("#dInput").classList.remove("hidden");
      $("#dNext").textContent="–î–∞–ª–µ–µ";
      $("#dNext").classList.remove("hidden");
      $("#dInput").focus();
    }
  }else{
    saveDoctor();
  }
}

function selectDoctorOption(idx,btn,type){
  if(type==="single"){
    doctorAnswers.push(idx);
    renderDoctorStep();
  }else{
    btn.classList.toggle("bg-indigo-600");
    const arr = doctorAnswers[doctorAnswers.length] || [];
    const pos = arr.indexOf(idx);
    if(pos>-1) arr.splice(pos,1); else arr.push(idx);
    doctorAnswers[doctorAnswers.length] = arr;
  }
}

$("#dNext").onclick = ()=>{
  const q = doctorQuestions[doctorAnswers.length];
  if(q.type==="number"){
    const v=$("#dInput").value.trim();
    if(!v) return alert("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ");
    doctorAnswers.push(Number(v));
  }else if(q.type==="multi"){
    const arr = doctorAnswers[doctorAnswers.length]||[];
    doctorAnswers.push(arr);
  }
  renderDoctorStep();
};

function renderPatientSummary(){
  $("#doctorQuiz").classList.remove("hidden");
  const ul=$("#summary"); ul.innerHTML="";
  patientQuestions.forEach((q,i)=>{
    const li=document.createElement("li");
    li.className="mb-1";
    const val = Array.isArray(patientAnswers[i])
      ? patientAnswers[i].map(j=>q.options[j]).join(", ")
      : (q.options ? q.options[patientAnswers[i]] : patientAnswers[i]);
    li.textContent=`${q.label}: ${val}`;
    ul.append(li);
  });
}

async function saveDoctor(){
  const upd={finishedAt:Date.now()};
  doctorQuestions.forEach((q,i)=>upd[`d${i+1}`]=doctorAnswers[i]);
  upd.score=calculateScore(patientAnswers,doctorAnswers);
  await updateDoc(doc(db,"surveys",docId),upd);
  alert(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª: ${upd.score}`);
  location.search="?role=admin";   // –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ç–∞–±–ª–∏—Ü—É
}

/*-------------------------------------------------------
  8.  –†–ï–ñ–ò–ú ADMIN
-------------------------------------------------------*/
async function initAdmin(){
  const snap = await getDocs(collection(db,"surveys"));
  const rows=[];
  snap.forEach(d=>{
    const s=d.data();
    rows.push({
      id:d.id,
      code:s.code,
      fio:s.p1,
      age:s.p2,
      temp:["–ù–µ—Ç","–ö—Ä–∞—Ç–∫.","–î–µ—Ä–∂–∏—Ç—Å—è"][s.p3]||"",
      risks:(s.p4||[]).map(j=>patientQuestions[3].options[j]).join(", "),
      pain:s.p5,
      cough: doctorQuestions[0].options[s.d1]||"",
      spo2 : doctorQuestions[1].options[s.d2]||"",
      therapy:(s.d3||[]).map(j=>doctorQuestions[2].options[j]).join(", "),
      score:s.score??""
    });
  });
  drawTable(rows);
}

function drawTable(rows){
  const tbl=$("#admTable"); tbl.innerHTML="";
  if(!rows.length){ tbl.textContent="–ù–µ—Ç –∞–Ω–∫–µ—Ç"; return;}
  const thead=document.createElement("thead");
  const tr=document.createElement("tr");
  Object.keys(rows[0]).forEach(h=>{
    const th=document.createElement("th");
    th.className="px-2 py-1 border"; th.textContent=h;
    tr.append(th);
  });
  thead.append(tr); tbl.append(thead);
  const tbody=document.createElement("tbody");
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    Object.values(r).forEach(v=>{
      const td=document.createElement("td");
      td.className="px-2 py-1 border"; td.textContent=v;
      tr.append(td);
    });
    tbody.append(tr);
  });
  tbl.append(tbody);
  $("#download").onclick = ()=>downloadExcel(rows);
}

function downloadExcel(rows){
  const ws=XLSX.utils.json_to_sheet(rows,{header:Object.keys(rows[0])});
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"surveys");
  XLSX.writeFile(wb,"surveys.xlsx");
}

/*-------------------------------------------------------
  9.  –°–¢–ê–†–¢
-------------------------------------------------------*/
document.addEventListener("DOMContentLoaded",()=>{
  if(role==="patient"){
    code=generateCode();
    $("#quiz").classList.remove("hidden");
    renderPatientStep();
  }else if(role==="doctor"){
    initDoctor();
  }else if(role==="admin"){
    $("#admin").classList.remove("hidden");
    initAdmin();
  }
});
</script>

<!-- QRious –¥–ª—è QR-–∫–æ–¥–∞ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<style>
/* –∫—Ä—É–ø–Ω—ã–µ –∫–Ω–æ–ø–∫–∏-–≤–∞—Ä–∏–∞–Ω—Ç—ã */
.btn-option{
 @apply bg-indigo-500/90 hover:bg-indigo-600 text-white py-2 px-4 rounded transition;
}
.btn-option.bg-indigo-600{/* selected state */}
</style>
</head>
<body class="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 via-fuchsia-600 to-rose-500">
<div id="container" class="p-4 w-full max-w-md">
  <!-- –ü–ê–¶–ò–ï–ù–¢ -->
  <div id="quiz" class="hidden bg-white/90 backdrop-blur-md rounded-xl p-6">
    <h2 id="title" class="text-xl font-semibold mb-4"></h2>
    <input id="inputText" class="hidden w-full border rounded mb-4 px-3 py-2" />
    <div id="options"></div>
    <p id="hint" class="hidden text-sm text-gray-500 mt-2">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</p>
    <button id="nextBtn" class="hidden w-full mt-4 bg-indigo-600 text-white py-2 rounded">
      –î–∞–ª–µ–µ
    </button>
  </div>

  <!-- QR + –∫–æ–¥ -->
  <div id="result" class="hidden bg-white/90 backdrop-blur-md rounded-xl p-6 text-center">
    <p class="mb-2 text-lg">–í–∞—à –∫–æ–¥</p>
    <p id="showCode" class="text-4xl font-bold mb-4"></p>
    <canvas id="qr" class="mx-auto"></canvas>
    <p class="mt-4 text-sm font-medium">–ü–µ—Ä–µ–¥–∞–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤—Ä–∞—á—É <br>(–Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É)</p>
    <a id="qrLink" class="text-xs break-all text-blue-600 underline" target="_blank"></a>
  </div>

  <!-- –î–û–ö–¢–û–†: –≤–≤–æ–¥ –∫–æ–¥–∞ -->
  <div id="doctorStart" class="hidden bg-white/90 backdrop-blur-md rounded-xl p-6 text-center">
    <p class="mb-4">–í–≤–µ–¥–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –ø–∞—Ü–∏–µ–Ω—Ç–∞</p>
    <input id="doctorCode" maxlength="4" class="w-full border rounded mb-4 text-center text-xl py-2" />
    <button id="findByCodeBtn" class="w-full bg-indigo-600 text-white py-2 rounded">–ù–∞–π—Ç–∏</button>
  </div>

  <!-- –î–û–ö–¢–û–†: –∞–Ω–∫–µ—Ç–∞ -->
  <div id="doctorQuiz" class="hidden bg-white/90 backdrop-blur-md rounded-xl p-6">
    <h3 class="text-lg font-semibold mb-2">–û—Ç–≤–µ—Ç—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞</h3>
    <ul id="summary" class="mb-4 list-disc pl-5 text-sm"></ul>
    <h2 id="dTitle" class="text-xl font-semibold mb-4"></h2>
    <input id="dInput" class="hidden w-full border rounded mb-4 px-3 py-2" />
    <div id="dOptions"></div>
    <p id="dHint" class="hidden text-sm text-gray-500 mt-2">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</p>
    <button id="dNext" class="hidden w-full mt-4 bg-indigo-600 text-white py-2 rounded">
      –î–∞–ª–µ–µ
    </button>
  </div>

  <!-- ADMIN -->
  <div id="admin" class="hidden bg-white/90 backdrop-blur-md rounded-xl p-6">
    <h2 class="text-xl font-semibold mb-4">–í—Å–µ –∞–Ω–∫–µ—Ç—ã</h2>
    <div class="overflow-x-auto max-h-96 mb-4">
      <table id="admTable" class="text-xs border-collapse w-full"></table>
    </div>
    <button id="download" class="w-full bg-indigo-600 text-white py-2 rounded">–°–∫–∞—á–∞—Ç—å Excel</button>
  </div>
</div>
</body>
</html>
