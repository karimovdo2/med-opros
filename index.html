<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å–Ω–∏–∫</title>
  <!-- Site branding -->
  <link rel="icon" type="image/png" sizes="96x96" href="./img/logo.png">
  <link rel="apple-touch-icon" href="./img/logo.png">
  <meta name="theme-color" content="#7c3aed" />
  <!-- TailwindCSS (demo) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS (Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- QRious -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <style>
    /* enlarge range thumb */
    input[type=range].big-thumb::-webkit-slider-thumb{ -webkit-appearance:none; width:32px;height:32px;border-radius:50%;background:#4f46e5;cursor:pointer;box-shadow:0 0 8px rgba(0,0,0,.25)}
    input[type=range].big-thumb::-moz-range-thumb{width:32px;height:32px;border-radius:50%;background:#4f46e5;cursor:pointer;box-shadow:0 0 8px rgba(0,0,0,.25)}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.11.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.11.0/firebase-firestore.js";

    /* ========== 1. Firebase (–≤—Å—Ç–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ) ========= */
    const firebaseConfig={ apiKey:"YOUR_API_KEY", authDomain:"clinic-quiz.firebaseapp.com", projectId:"clinic-quiz", storageBucket:"clinic-quiz.appspot.com", messagingSenderId:"YOUR_SENDER_ID", appId:"YOUR_APP_ID"};
    const app=initializeApp(firebaseConfig);
    const db=getFirestore(app);

    /* ========== 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–æ–ø—Ä–æ—Å—ã ========= */
    const patientQuestions=[
      {type:"text",   label:"–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ"},
      {type:"slider", label:"–í–æ–∑—Ä–∞—Å—Ç", min:0,max:99,start:25,unit:" –ª–µ—Ç", scorePerVal:0},
      {type:"single", label:"–ë—ã–ª –ª–∏ –æ–∑–Ω–æ–± –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—É—Ç–∫–∏?", options:[{label:"–ù–µ—Ç",score:0},{label:"–ù–µ–±–æ–ª—å—à–æ–π",score:-2},{label:"–°–∏–ª—å–Ω—ã–π",score:-4}]},
      {type:"multi",  label:"–û—Ç–º–µ—Ç—å—Ç–µ —Å–∏–º–ø—Ç–æ–º—ã", options:[{label:"–ö–∞—à–µ–ª—å",score:1},{label:"–ù–∞—Å–º–æ—Ä–∫",score:2},{label:"–ì–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å",score:2},{label:"–ë–æ–ª—å –≤ –≥–æ—Ä–ª–µ",score:1}]},
      {type:"pain",   label:"–û—Ü–µ–Ω–∏—Ç–µ –±–æ–ª—å"}
    ];

    const doctorQuestions=[
      {type:"slider", label:"SpO‚ÇÇ (%)", min:0,max:100,start:97,unit:"%", scoreFormula:v=>v<95?2:0},
      {type:"single", label:"–ê—É—Å–∫—É–ª—å—Ç–∞—Ü–∏—è –ª—ë–≥–∫–∏—Ö", options:[{label:"–í–µ–∑–∏–∫—É–ª—è—Ä–Ω–æ–µ",score:0},{label:"–û—Å–ª–∞–±–ª–µ–Ω–Ω–æ–µ",score:1},{label:"–•—Ä–∏–ø—ã",score:2}]},
      {type:"emoji",  label:"–û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞", emojiSet:"sad"}
    ];

    /* ========== 3. –®–∞–±–ª–æ–Ω—ã UI ========= */
    const root=document.body;
    const baseInput="w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg";
    const card=()=>{const d=document.createElement("div");d.className="max-w-lg w-full bg-white/80 backdrop-blur rounded-xl p-6 mx-auto mt-12 shadow-xl";return d};
    const bigBtn=(t,c="indigo")=>{const b=document.createElement("button");b.textContent=t;b.className=`w-full py-3 mt-4 rounded-lg text-lg font-semibold text-white bg-${c}-600 hover:bg-${c}-700 transition`;return b};

    const stepHeader=(i,total)=>{const h=document.createElement("h2");h.className="text-2xl font-semibold mb-6 text-center";h.textContent=`–®–∞–≥ ${i+1} –∏–∑ ${total}`;return h};
    const qLabel=t=>{const p=document.createElement("p");p.className="text-xl font-medium mb-4";p.textContent=t;return p};
    const noteMulti=()=>{const p=document.createElement("p");p.className="text-sm text-gray-600 mb-2";p.textContent="–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤";return p};

    const genCode=()=>String(Math.floor(1000+Math.random()*9000));

    /* ===== helper: generic slider ===== */
    function makeSlider(q){
      const number=document.createElement("input");number.type="number";number.min=q.min;number.max=q.max;number.value=q.start||q.min;number.className=baseInput;
      const big=document.createElement("div");big.className="flex justify-center text-4xl font-bold my-4";const span=document.createElement("span");span.textContent=number.value+(q.unit||"");big.appendChild(span);
      const range=document.createElement("input");range.type="range";range.min=q.min;range.max=q.max;range.value=number.value;range.className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer big-thumb";
      const sync=v=>{number.value=v;range.value=v;span.textContent=v+(q.unit||"");};
      number.oninput=()=>{let v=Math.max(q.min,Math.min(q.max,Number(number.value)||q.min));sync(v)};
      range.oninput=()=>sync(range.value);
      const wrap=document.createElement("div");wrap.append(number,big,range);
      return {wrap,get:()=>Number(range.value)};
    }

    /* ===== helper: emoji scale ===== */
    function makeEmoji(char,baseSize){
      let val=3;
      const number=document.createElement("input");number.type="number";number.min=1;number.max=5;number.value=val;number.className=baseInput;
      const scale=document.createElement("div");scale.className="flex justify-between items-end my-4";
      for(let i=1;i<=5;i++){const col=document.createElement("div");col.className="flex flex-col items-center";const e=document.createElement("span");e.textContent=char;e.style.fontSize=`${baseSize+i*0.3}rem`;const n=document.createElement("span");n.textContent=i;n.className="mt-1 text-sm";col.append(e,n);scale.appendChild(col);}  
      const range=document.createElement("input");range.type="range";range.min=1;range.max=5;range.value=val;range.className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer big-thumb";
      const sync=v=>{val=v;number.value=v;range.value=v};
      number.oninput=()=>sync(Math.max(1,Math.min(5,Number(number.value)||1)));
      range.oninput=()=>sync(range.value);
      const wrap=document.createElement("div");wrap.append(number,scale,range);
      return {wrap,get:()=>val};
    }

    /* ========= 4. –ü–∞—Ü–∏–µ–Ω—Ç ========= */
    async function initPatient(){
      const answers=[];let step=0;const box=card();root.appendChild(box);
      render();
      function render(){
        box.innerHTML="";
        const q=patientQuestions[step];
        box.appendChild(stepHeader(step,patientQuestions.length));
        const qWrap=document.createElement("div");qWrap.className="mb-6";qWrap.appendChild(qLabel(q.label));
        let sliderObj,emojiObj,selections=[];
        if(q.type==="text"){const inp=document.createElement("input");inp.type="text";inp.className=baseInput;qWrap.appendChild(inp);box.append(qWrap,bigBtn("–î–∞–ª–µ–µ").addEventListener("click",()=>{const v=inp.value.trim();if(!v)return alert("–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ");answers.push(v);advance();}));}
        else if(["slider","number","age"].includes(q.type)){sliderObj=makeSlider(q);qWrap.appendChild(sliderObj.wrap);box.append(qWrap,bigBtn("–î–∞–ª–µ–µ").addEventListener("click",()=>{answers.push(sliderObj.get());advance();}));}
        else if(q.type==="single"){const opts=document.createElement("div");q.options.forEach((opt,i)=>{const btn=document.createElement("button");btn.textContent=opt.label;btn.className="w-full mb-3 py-3 rounded-lg border text-lg hover:bg-indigo-50";btn.onclick=()=>{answers.push(i);advance()};opts.appendChild(btn);});qWrap.appendChild(opts);box.appendChild(qWrap);}
        else if(q.type==="multi"){qWrap.appendChild(noteMulti());const opts=document.createElement("div");q.options.forEach((opt,i)=>{const b=document.createElement("button");b.textContent=opt.label;b.className="w-full mb-3 py-3 rounded-lg border text-lg hover:bg-emerald-50";b.onclick=()=>{selections.includes(i)?(selections=selections.filter(x=>x!==i),b.classList.remove("bg-emerald-200")):(selections.push(i),b.classList.add("bg-emerald-200"))};opts.appendChild(b);});qWrap.appendChild(opts);box.append(qWrap,bigBtn("–î–∞–ª–µ–µ").addEventListener("click",()=>{answers.push(selections);advance();}));}
        else if(q.type==="pain"){emojiObj=makeEmoji("üî•",1);qWrap.appendChild(emojiObj.wrap);box.append(qWrap,bigBtn("–î–∞–ª–µ–µ").addEventListener("click",()=>{answers.push(emojiObj.get());advance();}));}
        else if(q.type==="emoji"){const char=q.emojiSet==="sad"?"üòû":"üòä";emojiObj=makeEmoji(char,0.8);qWrap.appendChild(emojiObj.wrap);box.append(qWrap,bigBtn("–î–∞–ª–µ–µ").addEventListener("click",()=>{answers.push(emojiObj.get());advance();}));}
      }
      function advance(){step++;if(step<patientQuestions.length)render();else complete();}
      async function complete(){const code=genCode();const docData={code,createdAt:Date.now()};patientQuestions.forEach((_,i)=>docData[`p${i+1}`]=answers[i]);const ref=await addDoc(collection(db,"surveys"),docData);showQr(code,ref.id);}  }

    /* ========= 5. QR */
    function showQr(code,id){root.innerHTML="";const c=card();const p=document.createElement("p");p.className="text-center text-xl mb-4";p.innerHTML=`–í–∞—à <span class='font-bold text-5xl block my-2'>${code}</span><br>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–æ–º–µ—Ä –∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ –≤—Ä–∞—á—É`;const link=`${location.origin}${location.pathname}?role=doctor&id=${id}`;const canvas=document.createElement("canvas");new QRious({element:canvas,value:link,size:220});const a=document.createElement("a");a.href=link;a.textContent=link;a.className="block text-center text-indigo-600 underline mt-4 break-all";c.append(p,canvas,a);root.appendChild(c);}   

    /* ========= 6. Doctor ========= */
    async function initDoctor(){const u=new URL(location.href);const id=u.searchParams.get("id");if(id){renderDoctor(id);}else{renderDoctorSearch();}}

    function renderDoctorSearch(){const c=card();const lbl=qLabel("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–∞—Ü–∏–µ–Ω—Ç–∞:");const inp=document.createElement("input");inp.maxLength=4;inp.className=baseInput;const btn=bigBtn("–ù–∞–π—Ç–∏","emerald");btn.onclick=async()=>{if(inp.value.length!==4)return alert("–ö–æ–¥ –∏–∑ 4 —Ü–∏—Ñ—Ä");const q=query(collection(db,"surveys"),where("code","==",inp.value));const snap=await getDocs(q);if(snap.empty)return alert("–ê–Ω–∫–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");location.href=`${location.pathname}?role=doctor&id=${snap.docs[0].id}`;};c.append(lbl,inp,btn);root.appendChild(c);}

    async function renderDoctor(id){const dSnap=await getDoc(doc(db,"surveys",id));if(!dSnap.exists())return alert("–ê–Ω–∫–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");const docData=dSnap.data();const answers=[];let step=0;const box=card();root.appendChild(box);render();
      function render(){box.innerHTML="";if(step===0){const h=qLabel(`–ö–æ–¥ –ø–∞—Ü–∏–µ–Ω—Ç–∞: ${docData.code}`);h.classList.add("text-center");box.appendChild(h);}if(step>=doctorQuestions.length){finish();return;}const q=doctorQuestions[step];const qWrap=document.createElement("div");qWrap.className="mb-6";qWrap.appendChild(qLabel(q.label));let sliderObj,emojiObj,selections=[];
        if(["slider","number","age"].includes(q.type)){sliderObj=makeSlider(q);qWrap.appendChild(sliderObj.wrap);box.append(qWrap,bigBtn("–î–∞–ª–µ–µ").addEventListener("click",()=>{answers.push(sliderObj.get());step++;render();}));}
        else if(q.type==="single"){const opts=document.createElement("div");q.options.forEach((opt,i)=>{const b=document.createElement("button");b.textContent=opt.label;b.className="w-full mb-3 py-3 rounded-lg border text-lg hover:bg-indigo-50";b.onclick=()=>{answers.push(i);step++;render();};opts.appendChild(b);});qWrap.appendChild(opts);box.appendChild(qWrap);}
        else if(q.type==="multi"){qWrap.appendChild(noteMulti());const opts=document.createElement("div");q.options.forEach((opt,i)=>{const b=document.createElement("button");b.textContent=opt.label;b.className="w-full mb-3 py-3 rounded-lg border text-lg hover:bg-emerald-50";b.onclick=()=>{selections.includes(i)?(selections=selections.filter(x=>x!==i),b.classList.remove("bg-emerald-200")):(selections.push(i),b.classList.add("bg-emerald-200"))};opts.appendChild(b);});qWrap.appendChild(opts);box.append(qWrap,bigBtn("–î–∞–ª–µ–µ").addEventListener("click",()=>{answers.push(selections);step++;render();}));}
        else if(q.type==="emoji"){const char=q.emojiSet==="sad"?"üòû":"üòä";emojiObj=makeEmoji(char,0.8);qWrap.appendChild(emojiObj.wrap);box.append(qWrap,bigBtn("–î–∞–ª–µ–µ").addEventListener("click",()=>{answers.push(emojiObj.get());step++;render();}));}
      }
      async function finish(){const upd={};doctorQuestions.forEach((_,i)=>upd[`d${i+1}`]=answers[i]);upd.score=calcTotal({...docData,...upd});upd.finishedAt=Date.now();await updateDoc(doc(db,"surveys",id),upd);box.innerHTML="";const done=document.createElement("p");done.className="text-2xl font-semibold text-center";done.textContent=`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –ò—Ç–æ–≥: ${upd.score}`;box.appendChild(done);}  }

    /* ========= 7. Admin (—É–ø—Ä–æ—â—ë–Ω) ========= */
    async function initAdmin(){const snap=await getDocs(collection(db,"surveys"));if(snap.empty){root.textContent="–ù–µ—Ç –∞–Ω–∫–µ—Ç";return;}const rows=[];snap.forEach(d=>rows.push(d.data()));console.log(rows);const ws=XLSX.utils.json_to_sheet(rows);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"data");XLSX.writeFile(wb,"surveys.xlsx");root.textContent="Excel –≤—ã–≥—Ä—É–∂–µ–Ω";}

    /* ========= 8. –ü–æ–¥—Å—á—ë—Ç ========= */
    function calcTotal(d){let t=0;
      patientQuestions.forEach((q,i)=>{const a=d[`p${i+1}`];if(q.type==="slider"||q.type==="number"||q.type==="age")t+= (q.scorePerVal||0)*a;if(q.type==="single"&&a!=null)t+=q.options[a].score;if(q.type==="multi"&&Array.isArray(a))a.forEach(x=>t+=q.options[x].score);if(q.type==="pain"||q.type==="emoji")t+=a;});
      doctorQuestions.forEach((q,i)=>{const a=d[`d${i+1}`];if(q.type==="slider") t+= q.scoreFormula? q.scoreFormula(a):0; if(q.type==="single"&&a!=null)t+=q.options[a].score;if(q.type==="multi"&&Array.isArray(a))a.forEach(x=>t+=q.options[x].score);if(q.type==="emoji")t+=a;});
      return t;}

    /* ========= 9. Router ========= */
    const role=new URL(location.href).searchParams.get("role")||"patient";
    if(role==="patient") initPatient();
    else if(role==="doctor") initDoctor();
    else if(role==="admin") initAdmin();
  </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-4">
  <header class="w-full flex justify-center mt-6"><img src="./img/logo.png" alt="Med-–æ–ø—Ä–æ—Å" class="w-24 h-24 select-none pointer-events-none"/></header>
</body>
</html>
